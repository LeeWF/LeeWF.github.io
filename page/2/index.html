<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="愤怒的IT青年">
<meta property="og:url" content="http://www.yoursite.com/page/2/index.html">
<meta property="og:site_name" content="愤怒的IT青年">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="愤怒的IT青年">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.yoursite.com/page/2/"/>





  <title>愤怒的IT青年</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">愤怒的IT青年</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>
<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



<div class="custom-site-signature" >将来的你，一定会感谢此刻的自己…… </div>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yoursite.com/Hexo/2018/03/hexo-next-custom-setting.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liwenfeng">
      <meta itemprop="description" content="将来的你，一定会感谢此刻的自己……">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="愤怒的IT青年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Hexo/2018/03/hexo-next-custom-setting.html" itemprop="url">Hexo next主题个性化设置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-16T01:28:32+08:00">
                2018-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="配置颜色"><a href="#配置颜色" class="headerlink" title="配置颜色"></a>配置颜色</h2><h3 id="主要实现方法"><a href="#主要实现方法" class="headerlink" title="主要实现方法"></a>主要实现方法</h3><p>路径：<code>themes\next\source\css\_variables\base.styl</code> 下修改全局配色</p>
<h3 id="Next-Mist-footer颜色"><a href="#Next-Mist-footer颜色" class="headerlink" title="Next.Mist footer颜色"></a>Next.Mist footer颜色</h3><p>路径：<code>themes\next\source\css\_schemes\Mist\index.styl</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.footer &#123;</span><br><span class="line">  margin-top: 80px;</span><br><span class="line">  padding: 10px 0;</span><br><span class="line">  background: $whitesmoke;  //底部footer背景颜色颜色</span><br><span class="line">  color: $grey-dim;         //底部footer字体颜色</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Next-Mist-header背景颜色"><a href="#Next-Mist-header背景颜色" class="headerlink" title="Next.Mist header背景颜色"></a>Next.Mist header背景颜色</h3><p>路径：<code>themes\next\source\css\_schemes\Mist\_header.styl</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.header &#123; background: $whitesmoke; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Next-Mist-左上角brand配色"><a href="#Next-Mist-左上角brand配色" class="headerlink" title="Next.Mist 左上角brand配色"></a>Next.Mist 左上角brand配色</h3><h4 id="brand字体颜色"><a href="#brand字体颜色" class="headerlink" title="brand字体颜色"></a>brand字体颜色</h4><p>路径：<code>themes\next\source\css\_variables\Mist.styl</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$brand-color             = $custom-brand-color    //修改为你想要的颜色</span><br><span class="line">$brand-hover-color       = $brand-color</span><br></pre></td></tr></table></figure></p>
<h4 id="brand上下边框配色"><a href="#brand上下边框配色" class="headerlink" title="brand上下边框配色"></a>brand上下边框配色</h4><p>路径：<code>themes\next\source\css\_schemes\Mist\_header.styl</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i &#123;</span><br><span class="line">  position: relative;</span><br><span class="line">  display: block;</span><br><span class="line">  height: 2px;</span><br><span class="line">  background: $custom-brand-color;   \\配置为想要的颜色</span><br><span class="line">  +mobile() &#123; height: 3px; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="在右上角或者左上角实现fork-me-on-github"><a href="#在右上角或者左上角实现fork-me-on-github" class="headerlink" title="在右上角或者左上角实现fork me on github"></a>在右上角或者左上角实现fork me on github</h2><h3 id="实现效果图"><a href="#实现效果图" class="headerlink" title="实现效果图"></a>实现效果图</h3><!-- ![fork-me-on-github](Hexo-next主题个性化设置/fork-me-on-github.png) -->
<img src="/Hexo/2018/03/hexo-next-custom-setting/fork-me-on-github.png">
<h3 id="具体实现方法"><a href="#具体实现方法" class="headerlink" title="具体实现方法"></a>具体实现方法</h3><ul>
<li>点击 <a href="https://blog.github.com/2008-12-19-github-ribbons/" target="_blank" rel="noopener">这里</a>或者 <a href="http://tholman.com/github-corners/" target="_blank" rel="noopener">这里</a>挑选自己喜欢的样式，并复制代码</li>
<li>然后粘贴刚才复制的代码到<code>themes/next/layout/_layout.swig</code>文件中(放在<code>&lt;div class=&quot;headband&quot;&gt;&lt;/div&gt;</code>的下面)，并把<code>href</code>改为你的<code>github地址</code> 如：<code>https://github.com/username</code></li>
</ul>
<h2 id="修改文章底部的那个带-号的标签"><a href="#修改文章底部的那个带-号的标签" class="headerlink" title="修改文章底部的那个带#号的标签"></a>修改文章底部的那个带#号的标签</h2><h3 id="实现效果图-1"><a href="#实现效果图-1" class="headerlink" title="实现效果图"></a>实现效果图</h3><!-- ![文章底部标签](Hexo-next主题个性化设置/文章底部标签.png) -->
<img src="/Hexo/2018/03/hexo-next-custom-setting/文章底部标签.png">
<h3 id="具体实现方法-1"><a href="#具体实现方法-1" class="headerlink" title="具体实现方法"></a>具体实现方法</h3><p>修改模板<code>/themes/next/layout/_macro/post.swig</code>，搜索 <code>rel=&quot;tag&quot;&gt;#</code>，将 <code>#</code> 换成<code>&lt;i class=&quot;fa fa-tag&quot;&gt;&lt;/i&gt;</code></p>
<h2 id="在每篇文章末尾统一添加“本文结束”标记"><a href="#在每篇文章末尾统一添加“本文结束”标记" class="headerlink" title="在每篇文章末尾统一添加“本文结束”标记"></a>在每篇文章末尾统一添加“本文结束”标记</h2><h3 id="实现效果图-2"><a href="#实现效果图-2" class="headerlink" title="实现效果图"></a>实现效果图</h3><!-- ![文章结束标记](Hexo-next主题个性化设置/文章结束标记.png) -->
<img src="/Hexo/2018/03/hexo-next-custom-setting/文章结束标记.png">
<h3 id="具体实现方法-2"><a href="#具体实现方法-2" class="headerlink" title="具体实现方法"></a>具体实现方法</h3><ul>
<li><p>在路径<code>\themes\next\layout\_macro</code>中新建<code>passage-end-tag.swig</code> 文件,并添加以下内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% if not is_index %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"text-align:center;color: #ccc;font-size:14px;"</span>&gt;</span>-------------本文结束<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-paw"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>感谢您的阅读-------------<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>接着打开<code>\themes\next\layout\_macro\post.swig</code>文件，在<code>post-body</code>之后,<code>post-footer</code> 之前添加如下代码（<code>post-footer</code>前两个<code>DIV</code>之前）：<br>代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% if not is_index %&#125;</span><br><span class="line">    &#123;% include 'passage-end-tag.swig' %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>然后打开主题配置文件<code>_config.yml</code>,在末尾添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 文章末尾添加“本文结束”标记</span><br><span class="line">passage_end_tag:</span><br><span class="line">  enabled: true</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yoursite.com/Android/2018/03/cjl6dv1m10000gcq6yxcwv3vv.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liwenfeng">
      <meta itemprop="description" content="将来的你，一定会感谢此刻的自己……">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="愤怒的IT青年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android/2018/03/cjl6dv1m10000gcq6yxcwv3vv.html" itemprop="url">Android Intent的查找与匹配-PackageManagerService</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-07T21:22:51+08:00">
                2018-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h2 id="App信息表的构建"><a href="#App信息表的构建" class="headerlink" title="App信息表的构建"></a>App信息表的构建</h2><p>系统启动后就会注册各种系统服务[^link1]，如WindowManagerService、ActivityManagerService等,其中有一个就是PackageManagerService(后续简称PMS)。PMS启动后，会扫描系统中已安装的apk目录，如系统App安装的目录为/System/app/,第三方应用的目录为/data/app,PMS会解析apk包下的AndroidManifest.xml文件得到相关信息，而每个AndroidManifest.xml又包含了Activity、Service等组件的注册信息，当PMS扫描并且解析完这些信息之后就构建好了整个apk的信息树，大致流程如下:</p>
<p><img src="http://i2.kiimg.com/1949/918f81af0fdce712.png" alt="Markdown"></p>
<p>PMS部分构造函数如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//路径：frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span><br><span class="line">public class PackageManagerService extends IPackageManager.Stub &#123;</span><br><span class="line"></span><br><span class="line">//构造方法</span><br><span class="line">    public PackageManagerService(Context context, Installer installer,boolean factoryTest, boolean onlyCore) &#123;</span><br><span class="line">    </span><br><span class="line">        //获取data目录</span><br><span class="line">        File dataDir = Environment.getDataDirectory();</span><br><span class="line">        //data/data 目录</span><br><span class="line">        mAppDataDir = new File(dataDir, &quot;data&quot;);</span><br><span class="line">        //data/app 目录</span><br><span class="line">        mAppInstallDir = new File(dataDir, &quot;app&quot;);</span><br><span class="line">        //省略</span><br><span class="line">    </span><br><span class="line">        </span><br><span class="line">        File frameworkDir = new File(Environment.getRootDirectory(), &quot;framework&quot;);</span><br><span class="line">        //加载framework资源</span><br><span class="line">        alreadyDexOpted.add(frameworkDir.getPath() + &quot;/framework-res.apk&quot;);</span><br><span class="line">        //加载核心库</span><br><span class="line">        alreadyDexOpted.add(frameworkDir.getPath() + &quot;/core-libart.jar&quot;);</span><br><span class="line">        //省略</span><br><span class="line">        </span><br><span class="line">        // Collect ordinary system packages. 获取系统App安装路径</span><br><span class="line">        final File systemAppDir = new File(Environment.getRootDirectory(), &quot;app&quot;);</span><br><span class="line">        //扫描系统App安装路径</span><br><span class="line">        scanDirLI(systemAppDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                    | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0);</span><br><span class="line">                    </span><br><span class="line">                    </span><br><span class="line">        //非核心应用  </span><br><span class="line">        if (!mOnlyCore) &#123;</span><br><span class="line">                </span><br><span class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,SystemClock.uptimeMillis());</span><br><span class="line">            //扫描第三方App安装路径</span><br><span class="line">            scanDirLI(mAppInstallDir, 0, scanFlags | SCAN_REQUIRE_KNOWN, 0);</span><br><span class="line">            scanDirLI(mDrmAppPrivateInstallDir, PackageParser.PARSE_FORWARD_LOCK,scanFlags | SCAN_REQUIRE_KNOWN, 0);</span><br><span class="line">            //省略</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，PMS加载Framework资源与核心库后才开始扫描指定目录下的apk并进行解析。扫描函数为scanDirLI,该方法实现如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span><br><span class="line">public class PackageManagerService extends IPackageManager.Stub &#123;</span><br><span class="line"></span><br><span class="line">    private void scanDirLI(File dir, int parseFlags, int scanFlags, long currentTime) &#123;</span><br><span class="line">        //1、获取该目录下的所有文件</span><br><span class="line">        final File[] files = dir.listFiles();</span><br><span class="line">        //解析目录下所有apk文件</span><br><span class="line">        for (File file : files) &#123;</span><br><span class="line">            final boolean isPackage = (isApkFile(file) || file.isDirectory()) &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line">            //如果不是apk文件，则忽略</span><br><span class="line">            if (!isPackage) &#123;</span><br><span class="line">                // Ignore entries which are not packages</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            //省略</span><br><span class="line">            </span><br><span class="line">            Runnable scanTask = new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        //解析apk</span><br><span class="line">                        scanPackageLI(ref_file, ref_parseFlags | PackageParser.PARSE_MUST_BE_APK,ref_scanFlags, ref_currentTime, null);</span><br><span class="line">                    &#125; catch (PackageManagerException e) &#123;</span><br><span class="line">                        //省略</span><br><span class="line">                    &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>scanDirLI会扫描指定目录所有apk文件，然后通过scanPackageLI函数解析，scanPackageLI函数实现如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span><br><span class="line">public class PackageManagerService extends IPackageManager.Stub &#123;</span><br><span class="line">    </span><br><span class="line">    private PackageParser.Package scanPackageLI(File scanFile, int parseFlags, int scanFlags,long currentTime, UserHandle user) throws PackageManagerException &#123;</span><br><span class="line">        //1、创建一个包解析器</span><br><span class="line">        PackageParser pp = new PackageParser();</span><br><span class="line">        pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">        pp.setOnlyCoreApps(mOnlyCore);</span><br><span class="line">        pp.setDisplayMetrics(mMetrics);</span><br><span class="line">        final PackageParser.Package pkg;</span><br><span class="line">    </span><br><span class="line">        try &#123;</span><br><span class="line">             //2、解析apk包</span><br><span class="line">             pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line">            &#125; catch (PackageParserException e) &#123;</span><br><span class="line">             throw PackageManagerException.from(e);</span><br><span class="line">            &#125;</span><br><span class="line">        //省略</span><br><span class="line">    </span><br><span class="line">        // Note that we invoke the following method only if we are about to unpack an application</span><br><span class="line">        </span><br><span class="line">        //3、解析apk包中Activity、Service等组件，不同参scanPackageLI方法</span><br><span class="line">        PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanFlags | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line">    </span><br><span class="line">        return scannedPkg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由可看到<code>pkg = pp.parsePackage(scanFile, parseFlags);</code>在scanPackageLI中构造一个PackageParser，并调用了PackageParser类的parsePackage函数，具体如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//源码路径：frameworks/base/core/java/android/content/pm/PackageParser.java</span><br><span class="line">public class PackageParser &#123;</span><br><span class="line">    </span><br><span class="line">    public Package parsePackage(File packageFile, int flags) throws PackageParserException &#123;</span><br><span class="line">        //是否是文件夹类型</span><br><span class="line">        if (packageFile.isDirectory()) &#123;</span><br><span class="line">            return parseClusterPackage(packageFile, flags);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //解析单个apk</span><br><span class="line">            return parseMonolithicPackage(packageFile, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>parsePackage函数会根据packageFile类型选择不同的方法，例如packageFile是文件夹则解析文件夹所有apk，否则解析单个apk，我们来看看parseMonolithicPackage函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//源码路径：frameworks/base/core/java/android/content/pm/PackageParser.java</span><br><span class="line">public class PackageParser &#123;</span><br><span class="line">    //parseMonolithicPackage函数</span><br><span class="line">    @Deprecated</span><br><span class="line">    public Package parseMonolithicPackage(File apkFile, int flags) throws PackageParserException &#123;</span><br><span class="line">        //1、构建AssetManager</span><br><span class="line">        final AssetManager assets = new AssetManager();</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            //2、调用parseBaseApk函数</span><br><span class="line">            final Package pkg = parseBaseApk(apkFile, assets, flags);</span><br><span class="line">            pkg.codePath = apkFile.getAbsolutePath();</span><br><span class="line">            return pkg;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //parseBaseApk函数</span><br><span class="line">    private Package parseBaseApk(File apkFile, AssetManager assets, int flags) throws PackageParserException &#123;</span><br><span class="line">        final String apkPath = apkFile.getAbsolutePath();</span><br><span class="line">        final int cookie = loadApkIntoAssetManager(assets, apkPath, flags);</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            //3、构建资源</span><br><span class="line">            res = new Resources(assets, mMetrics, null);</span><br><span class="line">            //4、获取AndroidManifest.xml的解析器</span><br><span class="line">            parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line">            final String[] outError = new String[1];</span><br><span class="line">            //5、解析获取到AndroidManifest.xml</span><br><span class="line">            final Package pkg = parseBaseApk(res, parser, flags, outError);</span><br><span class="line">            return pkg;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">            IoUtils.closeQuietly(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由上面代码可以看出，parseMonolithicPackage函数最后调用了PackageParser类的parseBaseApk(res, parser, flags, outError)函数，这个函数实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">//源码路径：frameworks/base/core/java/android/content/pm/PackageParser.java</span><br><span class="line">public class PackageParser &#123;</span><br><span class="line"></span><br><span class="line">    private Package parseBaseApk(Resources res, XmlResourceParser parser, int flags,String[] outError) throws XmlPullParserException, IOException &#123;</span><br><span class="line">        Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, attrs, flags);</span><br><span class="line">        //1、解析到AndroidManifest的包名</span><br><span class="line">        pkgName = packageSplit.first;</span><br><span class="line">        </span><br><span class="line">        //2、构建Package对象</span><br><span class="line">        final Package pkg = new Package(pkgName);</span><br><span class="line">        </span><br><span class="line">        //3、解析AndroidManifest.xml中的元素</span><br><span class="line">        int outerDepth = parser.getDepth();</span><br><span class="line">        while ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        if (tagName.equals(&quot;application&quot;)) &#123;</span><br><span class="line">                //省略</span><br><span class="line">                //4、解析Application标签，我们的Activity、Service等都在这个标签内</span><br><span class="line">                if (!parseBaseApplication(pkg, res, parser, attrs, flags, outError)) &#123;</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125; else if (tagName.equals(&quot;overlay&quot;)) &#123;</span><br><span class="line">        &#125; //解析其他标签，省略</span><br><span class="line">        </span><br><span class="line">        return pkg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个parseBaseApk函数才是真正解析AndroidManifest.xml的函数。该函数解析application等标签，application中包含了Activity等标签、Service等标签，也就是intent所需的标签，我们看看解析application标签的函数parseBaseApplication:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">//源码路径：frameworks/base/core/java/android/content/pm/PackageParser.java</span><br><span class="line">public class PackageParser &#123;</span><br><span class="line"></span><br><span class="line">    private boolean parseBaseApplication(Package owner, Resources res,XmlPullParser parser, AttributeSet attrs, int flags, String[] outError) throws XmlPullParserException, IOException &#123;</span><br><span class="line">        //应用信息</span><br><span class="line">        final ApplicationInfo ai = owner.applicationInfo;</span><br><span class="line">        //包名</span><br><span class="line">        final String pkgName = owner.applicationInfo.packageName;</span><br><span class="line">        //1、获取Application标签的TypedArray</span><br><span class="line">        TypedArray sa = res.obtainAttributes(attrs,com.android.internal.R.styleable.AndroidManifestApplication);</span><br><span class="line">        //获取应用名</span><br><span class="line">        String name = sa.getNonConfigurationString(com.android.internal.R.styleable.AndroidManifestApplication_name, 0);</span><br><span class="line">        //省略</span><br><span class="line">        </span><br><span class="line">        //应用图标</span><br><span class="line">        ai.icon = sa.getResourceId(com.android.internal.R.styleable.AndroidManifestApplication_icon, 0);</span><br><span class="line">        //省略</span><br><span class="line">        //获取taskAffinity属性</span><br><span class="line">        ai.taskAffinity = buildTaskAffinityName(ai.packageName, ai.packageName,str, outError);</span><br><span class="line">        </span><br><span class="line">        final int innerDepth = parser.getDepth();</span><br><span class="line">        int type;</span><br><span class="line">        //2、迭代Appication元素下所有子元素</span><br><span class="line">        while ((type = parser.next()) != XmlPullParser.END_DOCUMENT &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">            if (a == null) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;return false;</span><br><span class="line">            &#125;</span><br><span class="line">            //获取标签名</span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            //解析Activity</span><br><span class="line">            if (tagName.equals(&quot;activity&quot;)) &#123;</span><br><span class="line">                Activity a = parseActivity(owner, res, parser, attrs, flags, outError, false,owner.baseHardwareAccelerated);</span><br><span class="line">                if (a == null) &#123;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">                owner.activities.add(a);</span><br><span class="line">                </span><br><span class="line">            &#125; else if (tagName.equals(&quot;receiver&quot;)) &#123;</span><br><span class="line">                Activity a = parseActivity(owner, res, parser, attrs, flags, outError, true, false);</span><br><span class="line">                if (a == null) &#123;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">                owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">            &#125; //省略 解析Service、Provider等其他标签的代码</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageParser函数中我们看到这个过程就是普通的xml解析，根据不同的标签调用不同的解析方法。例如，Activity标签会调用parseActivity()函数，然后返回一个activity实例，并且将这个实例添加到Package对象的activities列表中。<br>具体添加过程如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span><br><span class="line">public class PackageManagerService extends IPackageManager.Stub &#123;</span><br><span class="line">     </span><br><span class="line">     private PackageParser.Package scanPackageLI(File scanFile, int parseFlags, int scanFlags,long currentTime, UserHandle user) throws PackageManagerException &#123;</span><br><span class="line">        //省略</span><br><span class="line">        //调用不同参的scanPackageLI函数解析apk包</span><br><span class="line">        PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanFlags | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     //解析apk包</span><br><span class="line">     private PackageParser.Package scanPackageLI(PackageParser.Package pkg, int parseFlags,int scanFlags, long currentTime, UserHandle user) throws PackageManagerException &#123;</span><br><span class="line">        boolean success = false;</span><br><span class="line">        try &#123;</span><br><span class="line">            //调用scanPackageDirtyLI进行扫描apk包</span><br><span class="line">            final PackageParser.Package res = scanPackageDirtyLI(pkg, parseFlags, scanFlags,currentTime, user);</span><br><span class="line">            success = true;</span><br><span class="line">            return res;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageManagerService类的scanPackageDirtyLI函数会将解析到的Activity、Service等添加到对应的mActivities、mService等列表中。我们看关键代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span><br><span class="line"></span><br><span class="line">private PackageParser.Package scanPackageDirtyLI(PackageParser.Package pkg, int parseFlags,int scanFlags, long currentTime, UserHandle user) throws PackageManagerException &#123;</span><br><span class="line">    final File scanFile = new File(pkg.codePath);</span><br><span class="line">    //代码省略</span><br><span class="line">    synchronized (mPackages) &#123;</span><br><span class="line">            //省略</span><br><span class="line">            N = pkg.receivers.size();</span><br><span class="line">            r = null;</span><br><span class="line">            for (i=0; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">                a.info.processName = fixProcessName(pkg.applicationInfo.processName,a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                mReceivers.addActivity(a, &quot;receiver&quot;);</span><br><span class="line">                if ((parseFlags&amp;PackageParser.PARSE_CHATTY) != 0) &#123;</span><br><span class="line">                    if (r == null) &#123;</span><br><span class="line">                        r = new StringBuilder(256);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        r.append(&apos; &apos;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(a.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            N = pkg.activities.size();</span><br><span class="line">            r = null;</span><br><span class="line">            for (i=0; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">                a.info.processName = fixProcessName(pkg.applicationInfo.processName,a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                mActivities.addActivity(a, &quot;activity&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //省略</span><br><span class="line">    </span><br><span class="line">    return pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到.scanPackageDirtyLI函数会将上一步解析到的Activity、Service添加到mActivities、mReceivers中。这些类型定义是PackageManagerService的字段。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</span><br><span class="line">public class PackageManagerService extends IPackageManager.Stub &#123;</span><br><span class="line">    // All available activities, for your resolving pleasure.</span><br><span class="line">    //保存了所有Activity节点信息</span><br><span class="line">    final ActivityIntentResolver mActivities = new ActivityIntentResolver();</span><br><span class="line"></span><br><span class="line">    // All available receivers, for your resolving pleasure.</span><br><span class="line">    //保存了所有BroadcastReceiver节点信息</span><br><span class="line">    final ActivityIntentResolver mReceivers = new ActivityIntentResolver();</span><br><span class="line">    // All available services, for your resolving pleasure.</span><br><span class="line">    //保存了所有Service节点信息</span><br><span class="line">    final ServiceIntentResolver mServices = new ServiceIntentResolver();</span><br><span class="line">    //省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这一步，整个已安装apk的信息树就建立了，每个apk的应用名、包名、图标、Activity、Service等信息都储存在系统中，当用户使用Intent跳转到某个Activity或者Service时，系统则会在这个信息表中进行查找，符合要求的组件则会被启动起来，这样就通过intent将系统的各个组件连接在一起。</p>
<h2 id="Intent的匹配"><a href="#Intent的匹配" class="headerlink" title="Intent的匹配"></a>Intent的匹配</h2><p>下面我们再来分析Intent的匹配过程。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//intent示例：</span><br><span class="line">Intent intent =new Intent(this , MainActivity.class); </span><br><span class="line">this.startActivity(intent);</span><br></pre></td></tr></table></figure></p>
<p><del>这种指定了具体的组件，系统查找组件时会使用精确匹配，我们称为显式Intent</del><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent =new Intent(Intent.ACTION_ALL_APPS); </span><br><span class="line">this.startActivity(intent);</span><br></pre></td></tr></table></figure></p>
<p><del>这类不指定具体组件而是给出模糊属性的，我们称为隐式Intent</del></p>
<p>startActivity函数的具体实现在Activity类中，且最终调用startActivityForResult函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"></span><br><span class="line">public class Activity extends ContextThemeWrapper</span><br><span class="line">        implements LayoutInflater.Factory2,</span><br><span class="line">        Window.Callback, KeyEvent.Callback,</span><br><span class="line">        OnCreateContextMenuListener, ComponentCallbacks2,</span><br><span class="line">        Window.OnWindowDismissedCallback &#123;</span><br><span class="line">    </span><br><span class="line">    public void startActivityForResult(Intent intent, int requestCode, @Nullable Bundle options) &#123;</span><br><span class="line">        if (mParent == null) &#123;</span><br><span class="line">            //1、启动Activity</span><br><span class="line">            Instrumentation.ActivityResult ar =</span><br><span class="line">                    mInstrumentation.execStartActivity(this, mMainThread.getApplicationThread(), mToken, this,intent, requestCode, options);</span><br><span class="line">            //发送启动请求</span><br><span class="line">            if (ar != null) &#123;</span><br><span class="line">                    mMainThread.sendActivityResult(mToken, mEmbeddedID, requestCode, ar.getResultCode(),ar.getResultData());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //省略</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>startActivityForResult函数调用了Instrumentation的execStartActivity函数，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">路径：frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public ActivityResult execStartActivity(Context who, IBinder contextThread, IBinder token, Activity target,Intent intent, int requestCode, Bundle options) &#123;</span><br><span class="line">        IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">        Uri referrer = target != null ? target.onProvideReferrer() : null;</span><br><span class="line">        try &#123;</span><br><span class="line">            //将Intent的数据迁移到粘贴板中</span><br><span class="line">            intent.migrateExtraStreamToClipData();</span><br><span class="line">            //准备离开当前进程</span><br><span class="line">            intent.prepareToLeaveProcess();</span><br><span class="line">            //1、实际调用ActivityManagerService的startActivity方法</span><br><span class="line">            int result = ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != null ? target.mEmbeddedID : null,</span><br><span class="line">                        requestCode, 0, null, options);</span><br><span class="line">            //2、检测结果，并返回调给调用端</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Failure from system&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>Instrumentation.execStartActivity—ActivityManagerService.startActivity—ActivityManagerService.startActivityAsUser—mStackSupervisor.startActivityMayWait—ActivityManagerServiceresolveIntent</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yoursite.com/Android/2018/03/cjl6dv1mb0007gcq6jibxk3ri.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liwenfeng">
      <meta itemprop="description" content="将来的你，一定会感谢此刻的自己……">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="愤怒的IT青年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android/2018/03/cjl6dv1mb0007gcq6jibxk3ri.html" itemprop="url">Android源码设计模式 学习笔记（四） 原型模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-05T21:22:51+08:00">
                2018-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h2 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><pre><code>用原型实例指定创建对象的种类，并通过拷贝这些原型创建新的对象。被复制的实例就是“原型”，这个原型是可定制的。
</code></pre><p><strong>注意:clone是Object中的方法</strong></p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>（1）类初始化需要消化非常多的资源，这个资源包括数据、硬件资源等，通过原型拷贝避免这些消耗。 </li>
<li>（2）通过new产生的一个对象需要非常繁琐的数据准备或者权限，这时可以使用原型模式。 </li>
<li><p>（3）一个对象需要提供给其他对象访问，而且各个调用者可能都需要修改其值时，可以考虑使用原型模式拷贝多个对象供调用者使用，即保护性拷贝。</p>
<pre><code>应该注意的是：通过clone拷贝对象时并不会执行构造函数，因此，如果在构造函数中需要一些特殊的初始化操作的类型，在实现拷贝时，需要注意构造函数不会执行的问题
</code></pre><p>  ​    </p>
</li>
</ul>
<h3 id="角色介绍"><a href="#角色介绍" class="headerlink" title="角色介绍"></a>角色介绍</h3><p><img src="http://i4.piimg.com/1949/a7066a42067385ff.png" alt="贴图库"><br>角色介绍如下:</p>
<ul>
<li>Client:客户端用户。</li>
<li>Prototype：抽象类或者接口、声明具备clone能力。</li>
<li>ConcretePrototype：具体的实现类。</li>
</ul>
<h3 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h3><p><strong>浅拷贝</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//Book类扮演的是ConcretePrototype角色,Cloneable类扮演的是Prototype角色</span><br><span class="line"></span><br><span class="line">public class Book implements Cloneable&#123;</span><br><span class="line">    private String title;</span><br><span class="line">    private ArrayList&lt;String&gt; image = new ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    public Book() &#123;</span><br><span class="line">        super();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Book(String title) &#123;</span><br><span class="line">        super();</span><br><span class="line">        this.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ArrayList&lt;String&gt; getImage()&#123;</span><br><span class="line">        return image;</span><br><span class="line">    &#125;</span><br><span class="line">    public void addImage(String img)&#123;</span><br><span class="line">        this.image.add(img);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public String getTitle() &#123;</span><br><span class="line">        return title;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setTitle(String title) &#123;</span><br><span class="line">        this.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Object clone() throws CloneNotSupportedException &#123;</span><br><span class="line"></span><br><span class="line">        Book book = (Book)super.clone();</span><br><span class="line">        book.title = this.title;</span><br><span class="line">        book.image = this.image;</span><br><span class="line">        return book;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void showBook()&#123;</span><br><span class="line">        System.out.println(&quot;=====Start=====&quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;title：&quot;+title);</span><br><span class="line">        for(String img : image)&#123;</span><br><span class="line">            System.out.println(&quot;image name:&quot;+img);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;======End======&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行main方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Book book1 = new Book(&quot;书1&quot;);</span><br><span class="line">            book1.addImage(&quot;图1&quot;);</span><br><span class="line">            //第1次输出</span><br><span class="line">            book1.showBook();</span><br><span class="line"></span><br><span class="line">            Book book2 = (Book) book1.clone();</span><br><span class="line">            //第2次输出</span><br><span class="line">            book2.showBook();</span><br><span class="line"></span><br><span class="line">            book2.setTitle(&quot;书2&quot;);</span><br><span class="line">            book2.addImage(&quot;图2&quot;);</span><br><span class="line">            //第3次输出</span><br><span class="line">            book2.showBook();</span><br><span class="line">            </span><br><span class="line">            //第4次输出</span><br><span class="line">            book1.showBook();</span><br><span class="line">        &#125; catch (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">=====Start=====</span><br><span class="line">title:书1</span><br><span class="line">image name:图1</span><br><span class="line">======End======</span><br><span class="line"></span><br><span class="line">=====Start=====</span><br><span class="line">title:书1</span><br><span class="line">image name:图1</span><br><span class="line">======End======</span><br><span class="line"></span><br><span class="line">=====Start=====</span><br><span class="line">title:书2</span><br><span class="line">image name:图1</span><br><span class="line">image name:图2</span><br><span class="line">======End======</span><br><span class="line"></span><br><span class="line">=====Start=====</span><br><span class="line">title:书1</span><br><span class="line">image name:图1</span><br><span class="line">image name:图2</span><br><span class="line">======End======</span><br></pre></td></tr></table></figure></p>
<p>上述的原型模式的实现实际上只是一个浅拷贝，也称为影子拷贝，并不是将原始对象全都重新构造了一份，而是拷贝对象的字段引用了原始对象的字段。</p>
<p>可以发现，boo2对象在执行<code>book2.addImage(&quot;图2&quot;)</code>时，book1也会影响到。原因是book2的image只是单纯的指向了this.image引用，并没有重新构造一个image。</p>
<p>而在book2设置title，book1的title并没有发生变化,原因具体见连接:</p>
<p><a href="https://www.zybuluo.com/Beeder/note/807366" target="_blank" rel="noopener">java克隆中String的特殊性</a><br><a href="https://www.zybuluo.com/Beeder/note/807423" target="_blank" rel="noopener">深入java克隆</a></p>
<p><strong>深拷贝</strong></p>
<p>修改如下(其他不变)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected Object clone() throws CloneNotSupportedException &#123;</span><br><span class="line"></span><br><span class="line">        Book book = (Book)super.clone();</span><br><span class="line">        book.image = (ArrayList&lt;String&gt;) this.image.clone();</span><br><span class="line">        return book;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Android源码中的原型模式"><a href="#Android源码中的原型模式" class="headerlink" title="Android源码中的原型模式"></a>Android源码中的原型模式</h3><h4 id="原型模式-Intent的实现"><a href="#原型模式-Intent的实现" class="headerlink" title="原型模式 Intent的实现"></a>原型模式 Intent的实现</h4><p>示例:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(&quot;smsto:110&quot;);</span><br><span class="line">       Intent intent = new Intent(Intent.ACTION_SEND,uri);</span><br><span class="line">       intent.putExtra(&quot;sms_body&quot;, &quot;The SMS text&quot;);</span><br><span class="line">       //克隆</span><br><span class="line">       Intent intent2 = (Intent)intent.clone();</span><br><span class="line">       startActivity(intent2);</span><br></pre></td></tr></table></figure></p>
<p>看看Intent的clone()方法是如何实现的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//源码路径：frameworks/base/core/java/android/content/Intent.java</span><br><span class="line">public class Intent implements Parcelable, Cloneable &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object clone() &#123;</span><br><span class="line">        return new Intent(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Copy constructor.</span><br><span class="line">     */</span><br><span class="line">    public Intent(Intent o) &#123;</span><br><span class="line">        this.mAction = o.mAction;</span><br><span class="line">        this.mData = o.mData;</span><br><span class="line">        this.mType = o.mType;</span><br><span class="line">        this.mPackage = o.mPackage;</span><br><span class="line">        this.mComponent = o.mComponent;</span><br><span class="line">        this.mFlags = o.mFlags;</span><br><span class="line">        this.mContentUserHint = o.mContentUserHint;</span><br><span class="line">        if (o.mCategories != null) &#123;</span><br><span class="line">            this.mCategories = new ArraySet&lt;String&gt;(o.mCategories);</span><br><span class="line">        &#125;</span><br><span class="line">        if (o.mExtras != null) &#123;</span><br><span class="line">            this.mExtras = new Bundle(o.mExtras);</span><br><span class="line">        &#125;</span><br><span class="line">        if (o.mSourceBounds != null) &#123;</span><br><span class="line">            this.mSourceBounds = new Rect(o.mSourceBounds);</span><br><span class="line">        &#125;</span><br><span class="line">        if (o.mSelector != null) &#123;</span><br><span class="line">            this.mSelector = new Intent(o.mSelector);</span><br><span class="line">        &#125;</span><br><span class="line">        if (o.mClipData != null) &#123;</span><br><span class="line">            this.mClipData = new ClipData(o.mClipData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>clone()方法中并没有调用super.clone()方法来实现对象拷贝，而是调用了new Intent(this)。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yoursite.com/Android/2018/03/cjl6dv1m90006gcq6o2atx40d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liwenfeng">
      <meta itemprop="description" content="将来的你，一定会感谢此刻的自己……">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="愤怒的IT青年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android/2018/03/cjl6dv1m90006gcq6o2atx40d.html" itemprop="url">Android源码设计模式 学习笔记（三） Builder模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-04T21:22:51+08:00">
                2018-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h2 id="Builder模式"><a href="#Builder模式" class="headerlink" title="Builder模式"></a>Builder模式</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><pre><code>将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示。
</code></pre><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>（1）相同的方法，不同的执行顺序，产生不同的事件结果时。<br>（2）多个部件或零件，都可以装配到一个对象中，但是产生的运行结果又不相同时。<br>（3）产品类非常复杂，或者产品类中的调用顺序不同产生了不同的作用，这个使用建造者模式非常适合。<br>（4）当初始化一个对象特别复杂时，如参数多，且很多参数有默认值。</p>
<h3 id="Builder模式-的UML类图"><a href="#Builder模式-的UML类图" class="headerlink" title="Builder模式 的UML类图"></a>Builder模式 的UML类图</h3><p>UML类图如图3-1所示。<br>角色介绍:</p>
<ul>
<li>Product产品类—–产品的抽象类</li>
<li>Builder—–抽象Builder类，规范产品的组建，一般由子类实现具体的组建过程</li>
<li>ConcreteBuilder—–具体的Builder类</li>
<li>Director—–统一组装过程</li>
</ul>
<p><img src="http://i4.piimg.com/1949/1abbd470c5802441.png" alt="贴图库"></p>
<h3 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public interface Builder &#123;</span><br><span class="line"></span><br><span class="line">　　//创建部件A　　比如创建汽车车轮</span><br><span class="line">　　void buildPartA(); </span><br><span class="line">　　//创建部件B   比如创建汽车方向盘</span><br><span class="line">　　void buildPartB(); </span><br><span class="line">　　//创建部件C   比如创建汽车发动机</span><br><span class="line">　　void buildPartC();</span><br><span class="line">　　//返回最后组装成品结果 (返回最后装配好的汽车)</span><br><span class="line">　　Product getResult();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class ConcreteBuilder implements Builder &#123;</span><br><span class="line"></span><br><span class="line">　　Part partA, partB, partC; </span><br><span class="line">　　public void buildPartA() &#123;</span><br><span class="line">　　　　//这里是具体如何构建partA的代码</span><br><span class="line">　　&#125;; </span><br><span class="line">　　public void buildPartB() &#123; </span><br><span class="line">　　　　//这里是具体如何构建partB的代码</span><br><span class="line">　　&#125;; </span><br><span class="line">　　 public void buildPartC() &#123; </span><br><span class="line">　　　　//这里是具体如何构建partB的代码</span><br><span class="line">　　&#125;; </span><br><span class="line">　　 public Product getResult() &#123; </span><br><span class="line">　　　　//返回最后组装成品结果</span><br><span class="line">　　&#125;; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Director 类，负责制造</span><br><span class="line">public class Director &#123;</span><br><span class="line"></span><br><span class="line">　　private Builder builder;</span><br><span class="line"></span><br><span class="line">　　public Director( Builder builder ) &#123; </span><br><span class="line">　　　　this.builder = builder; </span><br><span class="line">　　&#125; </span><br><span class="line">　　// 将部件partA partB partC最后组成复杂对象</span><br><span class="line">　　//这里是将车轮 方向盘和发动机组装成汽车的过程</span><br><span class="line">　　public void construct() &#123; </span><br><span class="line">　　　　builder.buildPartA();</span><br><span class="line">　　　　builder.buildPartB();</span><br><span class="line">　　　　builder.buildPartC();</span><br><span class="line"></span><br><span class="line">　　&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public interface Product &#123; &#125;//产品</span><br><span class="line"></span><br><span class="line">public interface Part &#123; &#125;//部件</span><br><span class="line"></span><br><span class="line">//调用</span><br><span class="line">ConcreteBuilder builder = new ConcreteBuilder();</span><br><span class="line">Director director = new Director(builder); </span><br><span class="line"></span><br><span class="line">director.construct(); </span><br><span class="line">Product product = builder.getResult();</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通常一个类拥有多个角色，将构造函数、字段私有化，把Builder写成内部类，通过builder类的setter方法设置私有函数和方法，如此封装用户就只能通过Builder对象设置属性了。<br>简单实例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">//customView类</span><br><span class="line">public class customView &#123;</span><br><span class="line">	//创建静态config对象</span><br><span class="line">	private int a;</span><br><span class="line">	private int b;</span><br><span class="line">	</span><br><span class="line">	//私有构造方法</span><br><span class="line">	private customView()&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//Builder内部类</span><br><span class="line">	public static class Builder&#123;</span><br><span class="line">		int a;</span><br><span class="line">		int b;</span><br><span class="line"></span><br><span class="line">		//setter方法，设置config对象参数</span><br><span class="line">		public Builder setA(int a)&#123;</span><br><span class="line">			this.a = a;</span><br><span class="line">			return this;</span><br><span class="line">		&#125;</span><br><span class="line">		public Builder setB(int b)&#123;</span><br><span class="line">			this.b = b;</span><br><span class="line">			return this;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		void applyConfig(customView view)&#123;</span><br><span class="line">			view.a=this.a;</span><br><span class="line">			view.b=this.b;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		//返回view</span><br><span class="line">		public customView create()&#123;</span><br><span class="line">			customView view = new customView();</span><br><span class="line">			applyConfig(view);</span><br><span class="line">			return view;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用户调用如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">customView view = new customView.Builder()</span><br><span class="line">					.setA(0)</span><br><span class="line">					.setB(0)</span><br><span class="line">					.create();</span><br></pre></td></tr></table></figure></p>
<h3 id="Android源码中的Builder模式"><a href="#Android源码中的Builder模式" class="headerlink" title="Android源码中的Builder模式"></a>Android源码中的Builder模式</h3><h4 id="AlertDialog-Builder模式，通过Builder对象组装"><a href="#AlertDialog-Builder模式，通过Builder对象组装" class="headerlink" title="AlertDialog.Builder模式，通过Builder对象组装"></a>AlertDialog.Builder模式，通过Builder对象组装</h4><p>在开发过程中，我们经常用到AlertDialog，AlertDialog.Builder就是源码中最常用到的Builder模式，具体示例如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void showDialogs(Context context)&#123;</span><br><span class="line">	AlertDialog.Builder builder= new AlertDialog.Builder(context);</span><br><span class="line">	builder.setIcon(R.drawable.ic_launcher);</span><br><span class="line">	builder.setTitle(&quot;title&quot;);</span><br><span class="line">	builder.setMessage(&quot;message&quot;);</span><br><span class="line">	builder.setPositiveButton(&quot;Button&quot;, new DialogInterface.OnClickListener() &#123;</span><br><span class="line">		</span><br><span class="line">		@Override</span><br><span class="line">		public void onClick(DialogInterface dialog, int whichButton) &#123;</span><br><span class="line">			setTitle(&quot;点击了对话框上的Button&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);	</span><br><span class="line">	builder.create().show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从类名就可以看出这就是一个Builder模式，通过Builder对象组装Dialog的各个部分，如Icon、Title、Message等，将Dialog的构造和表示进行分离。相关源码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/AlertDialog.java</span><br><span class="line"></span><br><span class="line">public class AlertDialog extends Dialog implements DialogInterface &#123;</span><br><span class="line">    //AlertController 接收Builder成员变量p中的各个参数  实现类</span><br><span class="line">    private AlertController mAlert;</span><br><span class="line">    </span><br><span class="line">    //构造函数</span><br><span class="line">    protected AlertDialog(Context context, @StyleRes int themeResId) &#123;</span><br><span class="line">        this(context, themeResId, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //构造AlertDialog</span><br><span class="line">    AlertDialog(Context context, @StyleRes int themeResId, boolean createContextThemeWrapper) &#123;</span><br><span class="line">        super(context, createContextThemeWrapper ? resolveDialogTheme(context, themeResId) : 0,createContextThemeWrapper);</span><br><span class="line">        mWindow.alwaysReadCloseOnTouchAttr();</span><br><span class="line">        //构造AlertController</span><br><span class="line">        mAlert = new AlertController(getContext(), this, getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //实际上调用的是mAlert的setTitle方法</span><br><span class="line">    @Override</span><br><span class="line">    public void setTitle(CharSequence title) &#123;</span><br><span class="line">        super.setTitle(title);</span><br><span class="line">        mAlert.setTitle(title);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //实际上调用的是mAlert的setCustomTitle方法</span><br><span class="line">    public void setCustomTitle(View customTitleView) &#123;</span><br><span class="line">        mAlert的.setCustomTitle(customTitleView);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void setMessage(CharSequence message) &#123;</span><br><span class="line">        mAlert.setMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //省略</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">     //AlertDialog的内部类</span><br><span class="line">     public static class Builder &#123;</span><br><span class="line">        //1、储存AlertDialog的各个参数，Title、message、icon等</span><br><span class="line">        private final AlertController.AlertParams P;</span><br><span class="line">        </span><br><span class="line">        //属性省略</span><br><span class="line">        </span><br><span class="line">        public Builder(Context context) &#123;</span><br><span class="line">            this(context, resolveDialogTheme(context, 0));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        public Builder(Context context, int themeResId) &#123;</span><br><span class="line">            P = new AlertController.AlertParams(new ContextThemeWrapper(</span><br><span class="line">                    context, resolveDialogTheme(context, themeResId)));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        //Builder的其他代码省略</span><br><span class="line">        //2、设置各种参数</span><br><span class="line">        public Builder setTitle(CharSequence title) &#123;</span><br><span class="line">            P.mTitle = title;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line">        public Builder setMessage(@StringRes int messageId) &#123;</span><br><span class="line">            P.mMessage = P.mContext.getText(messageId);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line">        public Builder setIcon(Drawable icon) &#123;</span><br><span class="line">            P.mIcon = icon;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        //3、构建AlertDialog，传递参数</span><br><span class="line">        public AlertDialog create() &#123;</span><br><span class="line">            // 4、new AlertDialog对象，并且将参数传递给AlertDialog实例dialog</span><br><span class="line">            // Context has already been wrapped with the appropriate theme.</span><br><span class="line">            final AlertDialog dialog = new AlertDialog(P.mContext, 0, false);</span><br><span class="line">            //5、将p中的参数应用到dialog中的mAlert对象中去</span><br><span class="line">            P.apply(dialog.mAlert);</span><br><span class="line">            dialog.setCancelable(P.mCancelable);</span><br><span class="line">            if (P.mCancelable) &#123;</span><br><span class="line">                dialog.setCanceledOnTouchOutside(true);</span><br><span class="line">            &#125;</span><br><span class="line">            dialog.setOnCancelListener(P.mOnCancelListener);</span><br><span class="line">            dialog.setOnDismissListener(P.mOnDismissListener);</span><br><span class="line">            if (P.mOnKeyListener != null) &#123;</span><br><span class="line">                dialog.setOnKeyListener(P.mOnKeyListener);</span><br><span class="line">            &#125;</span><br><span class="line">            return dialog;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Builder类可以设置AlertDialog中的title、message、button等参数，这些参数都存储在类型为AlertController.AlertParams的变量p中,AlertController.AlertParams中包含了与AlertDialog识图中对应的成员变量。<br>在调用Builder类的create函数时会创建AlertDialog,并将Builder成员变量p中保存的参数应用到AlertDialog的nAlert对象中，即p.apply(dialog.mAlert)代码段。<br>apply函数实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">//代码：frameworks/base/core/java/com/android/internal/app/AlertController.java</span><br><span class="line">public class AlertController &#123;</span><br><span class="line">    //省略</span><br><span class="line">    public static class AlertParams &#123;</span><br><span class="line">        public void apply(AlertController dialog) &#123;</span><br><span class="line">                    if (mCustomTitleView != null) &#123;</span><br><span class="line">                        dialog.setCustomTitle(mCustomTitleView);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        if (mTitle != null) &#123;</span><br><span class="line">                            dialog.setTitle(mTitle);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (mIcon != null) &#123;</span><br><span class="line">                            dialog.setIcon(mIcon);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (mIconId != 0) &#123;</span><br><span class="line">                            dialog.setIcon(mIconId);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (mIconAttrId != 0) &#123;</span><br><span class="line">                            dialog.setIcon(dialog.getIconAttributeResId(mIconAttrId));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (mMessage != null) &#123;</span><br><span class="line">                        dialog.setMessage(mMessage);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (mPositiveButtonText != null) &#123;</span><br><span class="line">                        dialog.setButton(DialogInterface.BUTTON_POSITIVE, mPositiveButtonText,</span><br><span class="line">                                mPositiveButtonListener, null);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (mNegativeButtonText != null) &#123;</span><br><span class="line">                        dialog.setButton(DialogInterface.BUTTON_NEGATIVE, mNegativeButtonText,</span><br><span class="line">                                mNegativeButtonListener, null);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (mNeutralButtonText != null) &#123;</span><br><span class="line">                        dialog.setButton(DialogInterface.BUTTON_NEUTRAL, mNeutralButtonText,</span><br><span class="line">                                mNeutralButtonListener, null);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (mForceInverseBackground) &#123;</span><br><span class="line">                        dialog.setInverseBackgroundForced(true);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //如果设置了mItems，则表示是单选或多选列表，此时创建一个ListView</span><br><span class="line">                    // For a list, the client can either supply an array of items or an</span><br><span class="line">                    // adapter or a cursor</span><br><span class="line">                    if ((mItems != null) || (mCursor != null) || (mAdapter != null)) &#123;</span><br><span class="line">                        createListView(dialog);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    //将mView设置给Dialog</span><br><span class="line">                    if (mView != null) &#123;</span><br><span class="line">                        if (mViewSpacingSpecified) &#123;</span><br><span class="line">                            dialog.setView(mView, mViewSpacingLeft, mViewSpacingTop, mViewSpacingRight,</span><br><span class="line">                                    mViewSpacingBottom);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            dialog.setView(mView);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (mViewLayoutResId != 0) &#123;</span><br><span class="line">                        dialog.setView(mViewLayoutResId);</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">                &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在apply函数中，只是将AlertParams参数设置到AlertController中。例如，将标题设置到Dialog对应的标题识图中，将Message设置到内容视图中等。当我们获取到AlertDialog对象后，通过show函数就可以显示这个对话框。<br>AlertDialog中相关代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/AlertDialog.java</span><br><span class="line">public class AlertDialog extends Dialog implements DialogInterface &#123;</span><br><span class="line"></span><br><span class="line">    public static class Builder &#123;</span><br><span class="line">    </span><br><span class="line">          public AlertDialog create() &#123;</span><br><span class="line">                // Context has already been wrapped with the appropriate theme.</span><br><span class="line">                final AlertDialog dialog = new AlertDialog(P.mContext, 0, false);</span><br><span class="line">                //将参数设置到AlertController对象dialog中</span><br><span class="line">                P.apply(dialog.mAlert);</span><br><span class="line">                dialog.setCancelable(P.mCancelable);</span><br><span class="line">                if (P.mCancelable) &#123;</span><br><span class="line">                    dialog.setCanceledOnTouchOutside(true);</span><br><span class="line">                &#125;</span><br><span class="line">                dialog.setOnCancelListener(P.mOnCancelListener);</span><br><span class="line">                dialog.setOnDismissListener(P.mOnDismissListener);</span><br><span class="line">                if (P.mOnKeyListener != null) &#123;</span><br><span class="line">                    dialog.setOnKeyListener(P.mOnKeyListener);</span><br><span class="line">                &#125;</span><br><span class="line">                return dialog;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            /**</span><br><span class="line">             * Creates an &#123;@link AlertDialog&#125; with the arguments supplied to this</span><br><span class="line">             * builder and immediately displays the dialog.</span><br><span class="line">             * &lt;p&gt;</span><br><span class="line">             * Calling this method is functionally identical to:</span><br><span class="line">             * &lt;pre&gt;</span><br><span class="line">             *     AlertDialog dialog = builder.create();</span><br><span class="line">             *     dialog.show();</span><br><span class="line">             * &lt;/pre&gt;</span><br><span class="line">             */</span><br><span class="line">             </span><br><span class="line">            </span><br><span class="line">            public AlertDialog show() &#123;</span><br><span class="line">                final AlertDialog dialog = create();</span><br><span class="line">                dialog.show();</span><br><span class="line">                return dialog;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们再看看Dialog的show函数(该函数在Dialog类中):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/Dialog.java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    /**</span><br><span class="line">     * Start the dialog and display it on screen.  The window is placed in the</span><br><span class="line">     * application layer and opaque.  Note that you should not override this</span><br><span class="line">     * method to do initialization when the dialog is shown, instead implement</span><br><span class="line">     * that in &#123;@link #onStart&#125;.</span><br><span class="line">     */</span><br><span class="line">     //显示Dialog</span><br><span class="line">    public void show() &#123;</span><br><span class="line">        if (DBG) &#123;</span><br><span class="line">            Log.d(TAG, &quot;show&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //已经是显示状态，则return</span><br><span class="line">        if (mShowing) &#123;</span><br><span class="line">            if (mDecor != null) &#123;</span><br><span class="line">                if (mWindow.hasFeature(Window.FEATURE_ACTION_BAR)) &#123;</span><br><span class="line">                    mWindow.invalidatePanelMenu(Window.FEATURE_ACTION_BAR);</span><br><span class="line">                &#125;</span><br><span class="line">                mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCanceled = false;</span><br><span class="line">        //1、onCreate调用</span><br><span class="line">        if (!mCreated) &#123;</span><br><span class="line">            dispatchOnCreate(null);</span><br><span class="line">        &#125;</span><br><span class="line">        //2、onStart</span><br><span class="line">        onStart();</span><br><span class="line">        //3、获取DecorView</span><br><span class="line">        mDecor = mWindow.getDecorView();</span><br><span class="line">      </span><br><span class="line">        //省略  </span><br><span class="line">        //4、获取布局参数</span><br><span class="line">        WindowManager.LayoutParams l = mWindow.getAttributes();</span><br><span class="line">        if ((l.softInputMode</span><br><span class="line">                &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION) == 0) &#123;</span><br><span class="line">            WindowManager.LayoutParams nl = new WindowManager.LayoutParams();</span><br><span class="line">            nl.copyFrom(l);</span><br><span class="line">            nl.softInputMode |=</span><br><span class="line">                    WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION;</span><br><span class="line">            l = nl;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        try &#123;  </span><br><span class="line">            //5、将mDecor添加到mWindowManager中</span><br><span class="line">            mWindowManager.addView(mDecor添加到, l);</span><br><span class="line">            mShowing = true;</span><br><span class="line">            //发送一个显示Dialog的消息</span><br><span class="line">            sendShowMessage();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在show函数中主要做了如下几个事情:</p>
<ul>
<li>(1)通过dispatchOnCreate函数来调用AlertDialog中的onCreate函数:</li>
<li>(2)调用AlertDialog的onStart函数</li>
<li>最后将Dialog的DecorView添加到WindowManager中</li>
</ul>
<p>很明显，这就是一系列的典型的生命周期函数。按照惯例，AlertDialog的内容视图构建按理应该在onCreate函数中，我们来看看是不是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/AlertDialog.java</span><br><span class="line"></span><br><span class="line">public class AlertDialog extends Dialog implements DialogInterface &#123;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        //调用了AlertController的installContent方法</span><br><span class="line">        mAlert.installContent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在onCreate函数中主要调用了AlertController的installContent方法，Dialog中的onCreate函数只是一个空实现而已，可以忽略他。那么AlertDialog的内容视图必然就在installContent函数中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/com/android/internal/app/AlertController.java</span><br><span class="line"></span><br><span class="line">public class AlertController &#123;</span><br><span class="line"></span><br><span class="line">    public void installContent() &#123;</span><br><span class="line">        /* We use a custom title so never request a window title */</span><br><span class="line">        mWindow.requestFeature(Window.FEATURE_NO_TITLE);</span><br><span class="line">        int contentView = selectContentView();</span><br><span class="line">        mWindow.setContentView(contentView);</span><br><span class="line">        setupView();</span><br><span class="line">        setupDecor();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private int selectContentView() &#123;</span><br><span class="line">        if (mButtonPanelSideLayout == 0) &#123;</span><br><span class="line">            return mAlertDialogLayout;</span><br><span class="line">        &#125;</span><br><span class="line">        if (mButtonPanelLayoutHint == AlertDialog.LAYOUT_HINT_SIDE) &#123;</span><br><span class="line">            return mButtonPanelSideLayout;</span><br><span class="line">        &#125;</span><br><span class="line">        // TODO: use layout hint side for long messages/lists</span><br><span class="line">        return mAlertDialogLayout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>installContent函数的代码，但极为重要，它调用了Window对象的setContentView，这个setContentView就与Activity中的一模一样，实际上Activity最终也是调用Window对象的setContentView函数。因此，这里就是设置AlertDialog的内容布局，这个布局就是mAlertDialogLayout的值。这个值在AlertController的构造函数中进行了初始化，具体代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/com/android/internal/app/AlertController.java</span><br><span class="line"></span><br><span class="line">public class AlertController &#123;</span><br><span class="line"></span><br><span class="line">public AlertController(Context context, DialogInterface di, Window window) &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mDialogInterface = di;</span><br><span class="line">        mWindow = window;</span><br><span class="line">        mHandler = new ButtonHandler(di);</span><br><span class="line"></span><br><span class="line">        final TypedArray a = context.obtainStyledAttributes(null,</span><br><span class="line">                R.styleable.AlertDialog, R.attr.alertDialogStyle, 0);</span><br><span class="line">        //AlertController的布局id，也就是alert_dialog.xml布局</span><br><span class="line">        mAlertDialogLayout = a.getResourceId(</span><br><span class="line">                R.styleable.AlertDialog_layout, R.layout.alert_dialog);</span><br><span class="line">        mButtonPanelSideLayout = a.getResourceId(</span><br><span class="line">                R.styleable.AlertDialog_buttonPanelSideLayout, 0);</span><br><span class="line">        mListLayout = a.getResourceId(</span><br><span class="line">                R.styleable.AlertDialog_listLayout, R.layout.select_dialog);</span><br><span class="line">        //省略</span><br><span class="line">        a.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从AlertController的构造函数中可以看到，AlertDialog的布局资源就是select_dialog.xml这个布局，我们直接大致看他的结构如下:<br><img src="http://i1.buimg.com/1949/fbccd3cdb3e53740.png" alt="贴图库"><br>当通过Builder对象的setTitle、setMessage等方法设置具体内容时，就是将这些内容填充到对应的视图中。而AlertDialog也允许你通过setView传入内容视图，这个内容视图就是替换掉图中的内容视图(蓝色区域)，AlertDialog预留了一个costomPanel区域用来显示用户自定义的内容视图。我们来看看setupView函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">public class AlertController &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private void setupView() &#123;</span><br><span class="line">         </span><br><span class="line">        final View parentPanel = mWindow.findViewById(R.id.parentPanel);</span><br><span class="line">        final View defaultTopPanel = parentPanel.findViewById(R.id.topPanel);</span><br><span class="line">        //1、获取内容区域</span><br><span class="line">        final View defaultContentPanel = parentPanel.findViewById(R.id.contentPanel);</span><br><span class="line">        //1、获取按钮</span><br><span class="line">        final View defaultButtonPanel = parentPanel.findViewById(R.id.buttonPanel);</span><br><span class="line"></span><br><span class="line">        // Install custom content before setting up the title or buttons so</span><br><span class="line">        // that we can handle panel overrides.</span><br><span class="line">        final ViewGroup customPanel = (ViewGroup) parentPanel.findViewById(R.id.customPanel);</span><br><span class="line">        //自定义内容视图区域</span><br><span class="line">        setupCustomContent(customPanel);</span><br><span class="line"></span><br><span class="line">        final View customTopPanel = customPanel.findViewById(R.id.topPanel);</span><br><span class="line">        final View customContentPanel = customPanel.findViewById(R.id.contentPanel);</span><br><span class="line">        final View customButtonPanel = customPanel.findViewById(R.id.buttonPanel);</span><br><span class="line"></span><br><span class="line">        // Resolve the correct panels and remove the defaults, if needed.</span><br><span class="line">        final ViewGroup topPanel = resolvePanel(customTopPanel, defaultTopPanel);</span><br><span class="line">        final ViewGroup contentPanel = resolvePanel(customContentPanel, defaultContentPanel);</span><br><span class="line">        final ViewGroup buttonPanel = resolvePanel(customButtonPanel, defaultButtonPanel);</span><br><span class="line">        //2、初始化内容</span><br><span class="line">        setupContent(contentPanel);</span><br><span class="line">        setupButtons(buttonPanel);</span><br><span class="line">        //2、初始化标题</span><br><span class="line">        setupTitle(topPanel);</span><br><span class="line">        </span><br><span class="line">        //自定义视图可见性</span><br><span class="line">        final boolean hasCustomPanel = customPanel != null</span><br><span class="line">                &amp;&amp; customPanel.getVisibility() != View.GONE;</span><br><span class="line">        final boolean hasTopPanel = topPanel != null</span><br><span class="line">                &amp;&amp; topPanel.getVisibility() != View.GONE;</span><br><span class="line">        final boolean hasButtonPanel = buttonPanel != null</span><br><span class="line">                &amp;&amp; buttonPanel.getVisibility() != View.GONE;</span><br><span class="line"></span><br><span class="line">        // Only display the text spacer if we don&apos;t have buttons.</span><br><span class="line">        if (!hasButtonPanel) &#123;</span><br><span class="line">            if (contentPanel != null) &#123;</span><br><span class="line">                final View spacer = contentPanel.findViewById(R.id.textSpacerNoButtons);</span><br><span class="line">                if (spacer != null) &#123;</span><br><span class="line">                    spacer.setVisibility(View.VISIBLE);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mWindow.setCloseOnTouchOutsideIfNotSet(true);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (hasTopPanel) &#123;</span><br><span class="line">            // Only clip scrolling content to padding if we have a title.</span><br><span class="line">            if (mScrollView != null) &#123;</span><br><span class="line">                mScrollView.setClipToPadding(true);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Only show the divider if we have a title.</span><br><span class="line">            final View divider;</span><br><span class="line">            if (mMessage != null || mListView != null || hasCustomPanel) &#123;</span><br><span class="line">                divider = topPanel.findViewById(R.id.titleDivider);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                divider = topPanel.findViewById(R.id.titleDividerTop);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (divider != null) &#123;</span><br><span class="line">                divider.setVisibility(View.VISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Update scroll indicators as needed.</span><br><span class="line">        if (!hasCustomPanel) &#123;</span><br><span class="line">            final View content = mListView != null ? mListView : mScrollView;</span><br><span class="line">            if (content != null) &#123;</span><br><span class="line">                final int indicators = (hasTopPanel ? View.SCROLL_INDICATOR_TOP : 0)</span><br><span class="line">                        | (hasButtonPanel ? View.SCROLL_INDICATOR_BOTTOM : 0);</span><br><span class="line">                content.setScrollIndicators(indicators,</span><br><span class="line">                        View.SCROLL_INDICATOR_TOP | View.SCROLL_INDICATOR_BOTTOM);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final TypedArray a = mContext.obtainStyledAttributes(</span><br><span class="line">                null, R.styleable.AlertDialog, R.attr.alertDialogStyle, 0);</span><br><span class="line">        //设置背景</span><br><span class="line">        setBackground(a, topPanel, contentPanel, customPanel, buttonPanel,</span><br><span class="line">                hasTopPanel, hasCustomPanel, hasButtonPanel);</span><br><span class="line">        a.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //自定义内容视图区域</span><br><span class="line">    private void setupCustomContent(ViewGroup customPanel) &#123;</span><br><span class="line">        final View customView;</span><br><span class="line">        //如果用户设置了内容视图，那么将它显示在customPanel的custom布局里面</span><br><span class="line">        if (mView != null) &#123;</span><br><span class="line">            customView = mView;</span><br><span class="line">        &#125; else if (mViewLayoutResId != 0) &#123;</span><br><span class="line">            final LayoutInflater inflater = LayoutInflater.from(mContext);</span><br><span class="line">            customView = inflater.inflate(mViewLayoutResId, customPanel, false);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            customView = null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final boolean hasCustomView = customView != null;</span><br><span class="line">        if (!hasCustomView || !canTextInput(customView)) &#123;</span><br><span class="line">            mWindow.setFlags(WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM,</span><br><span class="line">                    WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (hasCustomView) &#123;</span><br><span class="line">            final FrameLayout custom = (FrameLayout) mWindow.findViewById(R.id.custom);</span><br><span class="line">            //显示用户设置的视图</span><br><span class="line">            custom.addView(customView, new LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line"></span><br><span class="line">            if (mViewSpacingSpecified) &#123;</span><br><span class="line">                custom.setPadding(</span><br><span class="line">                        mViewSpacingLeft, mViewSpacingTop, mViewSpacingRight, mViewSpacingBottom);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (mListView != null) &#123;</span><br><span class="line">                ((LinearLayout.LayoutParams) customPanel.getLayoutParams()).weight = 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            customPanel.setVisibility(View.GONE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个setupView顾名思义就是初始化AlertDialog布局中的各个部分，如标题区域、按钮区域、内容区域等，在该函数调用之后整个Dialog的视图内容全部设置完毕。而这些各区域的视图都属于mAlertDialogLayout布局中的子元素，Window对象又关联了mAlertDialogLayout的整个布局树，当调用完setupView之后整个视图树的数据都填充完毕。当用户调用了show函数时，WindosManager会将Window对象的DecorView(也就是mAlertDialogLayout对应的视图)，添加到用户的窗口上，并且显示出来。至此，整个Dialog就会出现在用户的视野中了。</p>
<hr>
<ul>
<li>AlertDialog</li>
<li><ul>
<li>Builder内部类</li>
</ul>
</li>
<li><ul>
<li>onCreate()方法调用AlertController类installContent()方法设置内容布局</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>AlertDialog.Builder—Builder、ConcreteBuilder、Dirctor角色</li>
<li><ul>
<li>初始化AlertController.AlertParams对象p储存数据(Title、message、icon等)</li>
</ul>
</li>
<li><ul>
<li>set方法将数据储存至AlertController.AlertParams对象p</li>
</ul>
</li>
<li><ul>
<li>create()方法储存将AlertController.AlertParams对象p数据应用至AlertController对象dialog.mAlert</li>
</ul>
</li>
<li><ul>
<li>show()方法调用AlertDialog父类Dialog的show()方法加载布局。</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>AlertController</li>
<li><ul>
<li>AlertParams内部类</li>
</ul>
</li>
<li><ul>
<li>接收数据(Title、message、icon等)</li>
</ul>
</li>
<li><ul>
<li>installContent()方法调用Window对象的setContentView函数设置AlertDialog的内容布局,并调用setupView()方法初始化布局</li>
</ul>
</li>
<li><ul>
<li>setupView()初始化布局</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>AlertController.AlertParams</li>
<li><ul>
<li>用于储存数据(Title、message、icon等)</li>
</ul>
</li>
<li><ul>
<li>apply()方法将数据传递给AlertDialog类实例化的AlertController对象</li>
</ul>
</li>
</ul>
<p>在AlertDialog的Builder模式中并没有看到Director角色的出现(其实在很多场景中，Android并没有按照《设计模式:可复用面向对象软件的基础》一书中描述的经典模式来实现，而是做了些修改，使得更易于使用)。这里的AlertDialog.Builder同时扮演了builder、ConcreteBuilder、Dirctor的角色，简化了Builder模式的设计。</p>
<hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yoursite.com/Android/2018/03/cjl6dv1mc0008gcq64ej09hnr.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liwenfeng">
      <meta itemprop="description" content="将来的你，一定会感谢此刻的自己……">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="愤怒的IT青年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android/2018/03/cjl6dv1mc0008gcq64ej09hnr.html" itemprop="url">Android源码设计模式 学习笔记（二） 单例模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-03T21:22:51+08:00">
                2018-03-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><h3 id="单例模式的定义"><a href="#单例模式的定义" class="headerlink" title="单例模式的定义"></a>单例模式的定义</h3><pre><code>确保某一个类只有一个实例，而且自行实例化并向整个系统提供这个实例。
</code></pre><p>单例模式应该是日常使用最为广泛的一种模式了。他的作用是确保某个类只有一个实例，避免产生多个对象消耗过多的资源。比如对数据库的操作时，就可以使用单例模式。</p>
<h3 id="各种单例"><a href="#各种单例" class="headerlink" title="各种单例"></a>各种单例</h3><h4 id="饿汉模式"><a href="#饿汉模式" class="headerlink" title="饿汉模式"></a>饿汉模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;  </span><br><span class="line">     private static Singleton instance = new Singleton();  </span><br><span class="line">     private Singleton ()&#123;</span><br><span class="line">     &#125;</span><br><span class="line">     public static Singleton getInstance() &#123;  </span><br><span class="line">        return instance;  </span><br><span class="line">     &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这个实现的核心在于将Singleton类的构造方法私有化，使得外部程序不能通过构造函数来构造Singleton对象。这种写法是在类装载时就实例化instance，他避免了多线程的同步问题。但是不能保证有别的方式去装载，没有达到懒加载。</p>
<hr>
<h4 id="懒汉模式（线程不安全）"><a href="#懒汉模式（线程不安全）" class="headerlink" title="懒汉模式（线程不安全）"></a>懒汉模式（线程不安全）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;  </span><br><span class="line">      private static Singleton instance;  </span><br><span class="line">      private Singleton ()&#123;</span><br><span class="line">      &#125;   </span><br><span class="line">      public static Singleton getInstance() &#123;  </span><br><span class="line">      if (instance == null) &#123;  </span><br><span class="line">          instance = new Singleton();  </span><br><span class="line">      &#125;  </span><br><span class="line">      return instance;  </span><br><span class="line">      &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>达到了懒加载，但是在多线程不能正常工作。</p>
<h4 id="懒汉模式（线程安全）"><a href="#懒汉模式（线程安全）" class="headerlink" title="懒汉模式（线程安全）"></a>懒汉模式（线程安全）</h4><p><strong><em>不建议使用</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;  </span><br><span class="line">      private static Singleton instance;  </span><br><span class="line">      private Singleton ()&#123;</span><br><span class="line">      &#125;</span><br><span class="line">      public static synchronized Singleton getInstance() &#123;  </span><br><span class="line">      if (instance == null) &#123;  </span><br><span class="line">          instance = new Singleton();  </span><br><span class="line">      &#125;  </span><br><span class="line">      return instance;  </span><br><span class="line">      &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>这种写法能够在多线程中很好的工作，但是每次调用getInstance方法都会进行同步，反应稍慢，会消耗不必要的资源，还会造成不必要的开销，所以这种不建议使用。</p>
<h4 id="DCL单例（Double-Check-Lock-双重检查锁定）"><a href="#DCL单例（Double-Check-Lock-双重检查锁定）" class="headerlink" title="DCL单例（Double Check Lock 双重检查锁定）"></a>DCL单例（Double Check Lock 双重检查锁定）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;  </span><br><span class="line">      private volatile static Singleton mSingleton;  </span><br><span class="line">      private Singleton ()&#123;</span><br><span class="line">      &#125;   </span><br><span class="line">      public static Singleton getSingleton() &#123;  </span><br><span class="line">      if (mSingleton == null) &#123;  </span><br><span class="line">          synchronized (Singleton.class) &#123;  </span><br><span class="line">          if (mSingleton == null) &#123;  </span><br><span class="line">              mSingleton = new Singleton();  </span><br><span class="line">          &#125;  </span><br><span class="line">         &#125;  </span><br><span class="line">     &#125;  </span><br><span class="line">     return mSingleton;  </span><br><span class="line">     &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这种写法在getSingleton方法中对singleton进行了两次判空，第一次是为了不必要的同步，第二次是为了在null的情况下创建实例。</p>
<p>DCL的优点：资源利用率高，第一次执行mSingleton时单例对象才会被实例化，效率高。<br>DCL的缺点：第一次加载时反应稍慢，也由于Java内存模型的原因偶尔会失败。在高并发环境下也有一定的缺陷，虽然发生概率很小。<br>DCL模式是使用最多的单例实现方式，它能够在需要的时候才实例化单例对象，并且能够在绝大多数的场景下保证单例对象的唯一性，除非你的代码在高并发场景比较复杂或者低于JDK 1.6版本下使用，否则，这种方式一般能够满足要求。</p>
<pre><code>JDK1.5之前会有DCL失效问题
</code></pre><p>原因分析：<br>    假设线程A执行到 mSingleton = new Singleton() 语句，看起来像是一句代码，但实际上它并不是一个原子操作，这句代码最终会被编译成多条汇编指令，它大致做了3件事情：</p>
<ul>
<li>(1) 给singleton的实例分配内存</li>
<li>(2) 调用singleton()的构造函数，初始化成员字段</li>
<li>(3) 将mSingleton对象指向分配的内存空间(此时mSingleton就不是null了)</li>
</ul>
<p>但是，由于java编译器允许处理器乱序执行，以及JDK1.5之前JMM(Java Memory Model,即java内存模型)中的Cache、寄存器到主内存回写顺序的规定，上面的第二和第三顺序是无法保证的。也就是说，执行顺序可能是1-2-3也可能是1-3-2。如果是后者，并且在3执行完毕、2未执行之前，被切换到线程B上，这时候mSingleton因为已经在线程A内执行过了第三点，mSingleton已经是非空了，所以，线程B直接取走mSingleton，再使用时就会报错，这就是DCL失效的问题，而且这种难以跟踪难以重视的错误很可能会隐藏很久。</p>
<pre><code>在JDK1.5之后，SUN官方已经注意到这个问题，调整了JVM，具现化了volatile关键字，因此，如果JDK是1.5或之后的版本，mSingleton的定义改成``private volatile static Singleton mSingleton = null`` 就可以保证mSingleton对象每次都是从主内存中读取，就可以使用DCL的写法完成单例模式。当然，volatitle 或多或少也会影响到性能，但考虑到程序的正确性，牺牲这点性能还是值得的。
</code></pre><hr>
<h4 id="静态内部类单例模式"><a href="#静态内部类单例模式" class="headerlink" title="静态内部类单例模式"></a>静态内部类单例模式</h4><p><strong><em>推荐使用</em></strong><br>由于DCL单例会在某些情况下出现 “双重检查锁定(DCL)失效” 的问题，在《Java并发编程实践》一书最后指出这种“优化”是丑陋的，不赞成使用。而建议用如下的代码代替：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Singleton &#123;  </span><br><span class="line">      private Singleton ()&#123;</span><br><span class="line">      &#125;</span><br><span class="line">      public static final Singleton getInstance() &#123;  </span><br><span class="line">          return SingletonHolder.INSTANCE;  </span><br><span class="line">      &#125; </span><br><span class="line">      /**</span><br><span class="line">      *静态内部类</span><br><span class="line">      */</span><br><span class="line">      private static class SingletonHolder &#123;  </span><br><span class="line">      private static final Singleton INSTANCE = new Singleton();  </span><br><span class="line">      &#125;   </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>这种是推荐使用的单例模式实现方式。当第一次加载Singleton类时并不会初始化INSTANCE，只有在第一次调用getInstance方法时才会导致INSTANCE被初始化。这种方式不仅能够保证线程安全，也能保证单例对象的唯一性，同时也延迟了单例的实例化。</p>
<h4 id="枚举单例"><a href="#枚举单例" class="headerlink" title="枚举单例"></a>枚举单例</h4><p><strong><em>推荐使用</em></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public enum Singleton &#123;  </span><br><span class="line">     INSTANCE;  </span><br><span class="line">     public void whateverMethod() &#123;  </span><br><span class="line">     &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>这种方式是Effective Java作者Josh Bloch 提倡的方式，它不仅能避免多线程同步问题，而且还能防止反序列化重新创建新的对象。</p>
<hr>
<h4 id="使用容器实现单例模式"><a href="#使用容器实现单例模式" class="headerlink" title="使用容器实现单例模式"></a>使用容器实现单例模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class SingletonManager &#123; </span><br><span class="line">　　private static Map&lt;String, Object&gt; objMap = new HashMap&lt;String,Object&gt;();</span><br><span class="line"></span><br><span class="line">　　private SingletonManager() &#123; </span><br><span class="line">　　&#125;</span><br><span class="line">　　public static void registerService(String key, Objectinstance) &#123;</span><br><span class="line">　　　　if (!objMap.containsKey(key) ) &#123;</span><br><span class="line">　　　　　　objMap.put(key, instance) ;</span><br><span class="line">　　　　&#125;</span><br><span class="line">　　&#125;</span><br><span class="line"></span><br><span class="line">　　public static ObjectgetService(String key) &#123;</span><br><span class="line">　　　　return objMap.get(key) ;</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将多种单例类型注入到一个统一的管理类中，在使用时根据key获取对象对应类型的对象。这种方式使得我们可以管理多种类型的单例，并且在使用时可以通过统一的接口进行获取操作，降低了用户的使用成本，也对用户隐藏了具体实现，降低了耦合度。</p>
<h4 id="单例模式总结"><a href="#单例模式总结" class="headerlink" title="单例模式总结"></a>单例模式总结</h4><pre><code>不管以哪种形式实现单例模式，它们的核心原理都是将构造函数私有化，并且通过静态方法获取一个唯一的实例，在这个获取的过程中必须保证线程安全，防止反实例化导致重新生成实例对象等问题。选择哪种实现方式取决于项目本身，如是否是复杂的并发环境，JDK版本是否过低、单例对象的资源消耗等。
</code></pre><table>
<thead>
<tr>
<th>类型</th>
<th style="text-align:center">简单描述</th>
<th style="text-align:left">存在问题</th>
</tr>
</thead>
<tbody>
<tr>
<td>饿汉模式</td>
<td style="text-align:center">[基本]静态方法get静态对象，类装载时就实例化对象</td>
<td style="text-align:left">没有达到懒加载</td>
</tr>
<tr>
<td>懒汉模式</td>
<td style="text-align:center">使用synchronized关键字，但每次get时都会进行同步</td>
<td style="text-align:left">达到懒加载，但反应比较慢</td>
</tr>
<tr>
<td>DCL单例</td>
<td style="text-align:center">使用volatile关键字，get时先判空再进行同步</td>
<td style="text-align:left">JDK1.5 之前无volatile关键字</td>
</tr>
<tr>
<td>静态内部类单例模式</td>
<td style="text-align:center">使用静态内部类，外部使用静态方法get调用</td>
<td style="text-align:left">推荐使用</td>
</tr>
<tr>
<td>枚举单例</td>
<td style="text-align:center"></td>
<td style="text-align:left">推荐使用</td>
</tr>
<tr>
<td>容器实现单例</td>
<td style="text-align:center">实例一个静态Map，通过put和get管理</td>
</tr>
</tbody>
</table>
<p>优点：</p>
<ul>
<li>（1）由于单例模式在内存中只有一个实例，减少了内存开支，特别是一个对象需要频繁的创建、销毁时，而且创建或销毁时性能又无法优化，单例模式的优势就非常明显。 </li>
<li>（2）单例模式可以避免对资源的多重占用，例如一个文件操作，由于只有一个实例存在内存中，避免对同一资源文件的同时操作。</li>
<li>（3）单例模式可以在系统设置全局的访问点，优化和共享资源访问，例如，可以设计一个单例类，负责所有数据表的映射处理。</li>
</ul>
<p>缺点：</p>
<ul>
<li>（1）单例模式一般没有接口，扩展很困难，若要扩展，只能修改代码来实现。</li>
<li>（2）单例对象如果持有Context，那么很容易引发内存泄露。此时需要注意传递给单例对象的Context最好是Application Context。</li>
</ul>
<hr>
<h3 id="Android源码中的单例模式"><a href="#Android源码中的单例模式" class="headerlink" title="Android源码中的单例模式"></a>Android源码中的单例模式</h3><h3 id="容器实现单例-Context的实现及系统服务的管理"><a href="#容器实现单例-Context的实现及系统服务的管理" class="headerlink" title="容器实现单例-Context的实现及系统服务的管理"></a>容器实现单例-Context的实现及系统服务的管理</h3><p>在Android系统中，我们经常会通过Context获取系统级别的服务，如WindowsManagerService、ActivityManagerService等，更常用的是一个LayoutInflater的类，这些服务会在合适的时候以单例的形式注册在系统中，在我们需要的时候就通过Context的getSystemService(String name)获取。</p>
<h4 id="2LayoutInflater类"><a href="#2LayoutInflater类" class="headerlink" title="2LayoutInflater类"></a>2LayoutInflater类</h4><p><em>源码路径：frameworks/base/core/java/android/view/LayoutInflater.java</em></p>
<p>通常我们使用<code>LayoutInflater.from</code>来获取LayoutInflater服务，<code>LayoutInflater.from(Context)</code>的实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Obtains the LayoutInflater from the given context.</span><br><span class="line"> */</span><br><span class="line">public static LayoutInflater from(Context context) &#123;</span><br><span class="line">    LayoutInflater LayoutInflater =</span><br><span class="line">            (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">    if (LayoutInflater == null) &#123;</span><br><span class="line">        throw new AssertionError(&quot;LayoutInflater not found.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return LayoutInflater;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出<code>from(Context)</code>函数内部调用的是Context类的<code>getSystemService(String key)</code>方法，我们跟踪到Context类看到，该类是抽象类:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//相关源码路径：frameworks/base/core/java/android/content/Context.java</span><br><span class="line"></span><br><span class="line">public abstract class Context &#123;</span><br><span class="line">//省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getView 中使用的Context对象的具体实现类是什么呢？其实在Application、Activity、Service中都会存在一个Context对象，即Contest的总个数Activity个数+Service个数+1，而ListView通常都是显示在Activity中，那么我们就以Acitviy中的Context来分析。<br>我们知道，一个Activity的入口是ActivityThread的main函数，在main函数中创建一个新的ActivityThread的对象，并且在启动消息循环(UI线程)、创建新的Activity、新的Context对象，然后将该Context对象传递给Activity。下面看到ActivityThread源代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">//相关源码路径：frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"></span><br><span class="line">public final class ActivityThread &#123;</span><br><span class="line">//省略</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //省略</span><br><span class="line">        Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);</span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        //创建ActivityThread对象</span><br><span class="line">        ActivityThread thread = new ActivityThread();</span><br><span class="line">        thread.attach(false);</span><br><span class="line"></span><br><span class="line">        if (sMainThreadHandler == null) &#123;</span><br><span class="line">            sMainThreadHandler = thread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">        //省略</span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    private void attach(boolean system) &#123;</span><br><span class="line">        sCurrentActivityThread = this;</span><br><span class="line">        mSystemThread = system;</span><br><span class="line">        //不是系统应用的情况</span><br><span class="line">        if (!system) &#123;</span><br><span class="line">            ViewRootImpl.addFirstDrawHandler(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    ensureJitEnabled();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            android.ddm.DdmHandleAppName.setAppName(&quot;&lt;pre-initialized&gt;&quot;,UserHandle.myUserId());</span><br><span class="line">            RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">            final IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">            </span><br><span class="line">            try &#123;</span><br><span class="line">                //关联mAppThread</span><br><span class="line">                mgr.attachApplication(mAppThread);</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                // Ignore</span><br><span class="line">            &#125;</span><br><span class="line">            //省略</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //省略</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在main方法中，我们创建了一个Activitythread对象后，调用了其attach函数，并且参数为false。在attach函数中，在参数为false的情况下(非系统应用)，会通过Binder机制与ActivityManagerService通信，并且最终调用handleLaunchActivity函数，我们看看该函数的实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">//相关源码路径：frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"></span><br><span class="line">public final class ActivityThread &#123;</span><br><span class="line">    //省略</span><br><span class="line">    private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">        //省略</span><br><span class="line">        Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">        //省略</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">    </span><br><span class="line">        Activity activity = null;</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">            //1、创建Acitvity</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            //省略</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            //省略</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //创建Application对象</span><br><span class="line">            Application app = r.packageInfo.makeApplication(false, mInstrumentation);</span><br><span class="line">            //省略</span><br><span class="line">            if (activity != null) &#123;</span><br><span class="line">                Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">                //2、获取Context对象</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration config = new Configuration(mCompatConfiguration);</span><br><span class="line">                //3、将appContext等对象attach到activity中</span><br><span class="line">                activity.attach(appContext, this, getInstrumentation(), r.token,r.ident, app, r.intent, r.activityInfo, title, r.parent,r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                r.referrer, r.voiceInteractor);</span><br><span class="line">                //省略</span><br><span class="line">                //4、调用Activity中的Create方法</span><br><span class="line">                if (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                //省略</span><br><span class="line">        &#125; catch (SuperNotCalledException e) &#123;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">           //省略</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    private Context createBaseContextForActivity(ActivityClientRecord r, final Activity activity) &#123;</span><br><span class="line">        //5、创建Context对象，可以看到实现类是ContextImpl</span><br><span class="line">        ContextImpl appContext = ContextImpl.createActivityContext(</span><br><span class="line">                this, r.packageInfo, displayId, r.overrideConfig);</span><br><span class="line">        appContext.setOuterContext(activity);</span><br><span class="line">        Context baseContext = appContext;</span><br><span class="line">        </span><br><span class="line">        return baseContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面的1-5注释处的代码分析可知道，Context的实现类为ContextImpl,其最终返回一个ContextImpl实例。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="line"></span><br><span class="line">class ContextImpl extends Context &#123;</span><br><span class="line">    private final static String TAG = &quot;ContextImpl&quot;;</span><br><span class="line">    </span><br><span class="line">    // The system service cache for the system services that are cached per-ContextImpl.</span><br><span class="line">    /用SystemServiceRegistry类.createServiceCache()创建系统服务</span><br><span class="line">    f实现。inal Object[] mServiceCache = SystemServiceRegistry.createServiceCache();</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    /*可以看到返回的是一个ContextImpl*/</span><br><span class="line">    static ContextImpl createActivityContext(ActivityThread mainThread,LoadedApk packageInfo, int displayId, Configuration overrideConfiguration) &#123;</span><br><span class="line">        if (packageInfo == null) throw new IllegalArgumentException(&quot;packageInfo&quot;);</span><br><span class="line">        return new ContextImpl(null, mainThread, packageInfo, null, null, false,null, overrideConfiguration, displayId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由ContextImpl类代码可以看到，创建系统服务时，调用的是SystemServiceRegistry类的createServiceCache方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/SystemServiceRegistry.java</span><br><span class="line"></span><br><span class="line">final class SystemServiceRegistry &#123;</span><br><span class="line">    </span><br><span class="line">    //实际返回Object[sServiceCacheSize]</span><br><span class="line">    public static Object[] createServiceCache() &#123;</span><br><span class="line">            return new Object[sServiceCacheSize];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Base interface for classes that fetch services.</span><br><span class="line">     * These objects must only be created during static initialization.</span><br><span class="line">     */</span><br><span class="line">    static abstract interface ServiceFetcher&lt;T&gt; &#123;</span><br><span class="line">        T getService(ContextImpl ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Override this class when the system service constructor needs a</span><br><span class="line">     * ContextImpl and should be cached and retained by that context.</span><br><span class="line">     */</span><br><span class="line">    static abstract class CachedServiceFetcher&lt;T&gt; implements ServiceFetcher&lt;T&gt; &#123;</span><br><span class="line">        private final int mCacheIndex;</span><br><span class="line"></span><br><span class="line">        public CachedServiceFetcher() &#123;</span><br><span class="line">            mCacheIndex = sServiceCacheSize++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        //获取系统服务[最终]</span><br><span class="line">        public final T getService(ContextImpl ctx) &#123;</span><br><span class="line">            final Object[] cache = ctx.mServiceCache;</span><br><span class="line">            synchronized (cache) &#123;</span><br><span class="line">                //从缓存中获取服务对象</span><br><span class="line">                // Fetch or create the service.</span><br><span class="line">                Object service = cache[mCacheIndex];</span><br><span class="line">                //没有就创建服务</span><br><span class="line">                if (service == null) &#123;</span><br><span class="line">                    service = createService(ctx);</span><br><span class="line">                    cache[mCacheIndex] = service;</span><br><span class="line">                &#125;</span><br><span class="line">                return (T)service;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //抽象方法，用于创建系统服务</span><br><span class="line">        public abstract T createService(ContextImpl ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在SystemServiceRegistry类中, 主要通过抽象内部类SystemServiceRegistry类控制service对象，如果没有service对象则通过实现抽象方法createServic来创建。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/SystemServiceRegistry.java</span><br><span class="line"></span><br><span class="line">final class SystemServiceRegistry &#123;</span><br><span class="line">    </span><br><span class="line">    //1、Service 容器</span><br><span class="line">    private static final HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =</span><br><span class="line">            new HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt;();</span><br><span class="line">    </span><br><span class="line">    //3、静态代码块，第一次加载该类时执行(只执行一次，保证实例的唯一性)</span><br><span class="line">    static&#123;</span><br><span class="line">        //省略</span><br><span class="line">        //注册LayoutInflater service</span><br><span class="line">        //调用上述代码的CachedServiceFetcher内部类创建系统服务对象</span><br><span class="line">        registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,new CachedServiceFetcher&lt;LayoutInflater&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public LayoutInflater createService(ContextImpl ctx) &#123;</span><br><span class="line">                        return new PhoneLayoutInflater(ctx.getOuterContext());</span><br><span class="line">            &#125;&#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * Statically registers a system service with the context.</span><br><span class="line">     * This method must be called during static initialization only.</span><br><span class="line">     */</span><br><span class="line">     //2、注册服务器</span><br><span class="line">    private static &lt;T&gt; void registerService(String serviceName, Class&lt;T&gt; serviceClass,ServiceFetcher&lt;T&gt; serviceFetcher) &#123;</span><br><span class="line">        SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);</span><br><span class="line">        //将Service对象加入Service容器</span><br><span class="line">        SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SystemServiceRegistry类中，1-3注释处代码为注册及创建Service对象的具体实现过程。<br>在静态代码块中。通过调用registerService方法，实现抽象内部类CachedServiceFetcher，并实现CachedServiceFetcher类的抽象方法createService方法创建Service对象,并将对象加入Service容器中。</p>
<p>结合上述代码可以看到，在虚拟机第一次加载时会注册各种serviceFetcher，其中就包含了LayoutInflater Service。将这些服务以键值对的形式储存在一个HashMap钟，用户使用时只需要根据key来获取到对应的serviceFetcher，然后通过serviceFetcher对象的getService函数来获取具体的服务对象。当第一次获取时，会调用serviceFetcher的CreatService函数创建服务对象，然后将该对象缓存到一个列表中，下次再获取时直接从缓存中获取，避免重复创建对象，从而达到单例的效果。这种模式就是‘通过容器实现的单例模式’，系统核心服务以单例形式存在，减少了资源。</p>
<hr>
<h3 id="LayoutInflater类"><a href="#LayoutInflater类" class="headerlink" title="LayoutInflater类"></a>LayoutInflater类</h3><p><em>LayoutInflater在我们的开发中扮演着重要的角色，但很多时候我们都不知道它的重要性，因为它的重要性被隐藏在了Activity、Fragment等组件的光环之下。</em><br>LayoutInflater是一个抽象类，具体代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//代码：frameworks/base/core/java/android/view/LayoutInflater.java</span><br><span class="line"></span><br><span class="line">public abstract class LayoutInflater &#123;</span><br><span class="line">    //代码省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>既然是抽象不是具体的，那我们就必须找出它的实现类。这需要先从LayoutInflater的起源开始，在上文中知道，在加载ContextImpl类时，会调用SystemServiceRegistry类，在SystemServiceRegistry类的静态代码块中会通过如下代码将LayoutInflater的serviceFetcher注入到Service容器中。具体代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/SystemServiceRegistry.java</span><br><span class="line"></span><br><span class="line">final class SystemServiceRegistry &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,</span><br><span class="line">                new CachedServiceFetcher&lt;LayoutInflater&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public LayoutInflater createService(ContextImpl ctx) &#123;</span><br><span class="line">                //创建Service实例</span><br><span class="line">                return new PhoneLayoutInflater(ctx.getOuterContext());</span><br><span class="line">            &#125;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果这里调用了PhoneLayoutInflater类，具体如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/com/android/internal/policy/PhoneLayoutInflater.java</span><br><span class="line"></span><br><span class="line">public class PhoneLayoutInflater extends LayoutInflater &#123;</span><br><span class="line">    //内置View类型的前缀，如TextView的完整路径是android.widget.TextView</span><br><span class="line">    private static final String[] sClassPrefixList = &#123;</span><br><span class="line">        &quot;android.widget.&quot;,</span><br><span class="line">        &quot;android.webkit.&quot;,</span><br><span class="line">        &quot;android.app.&quot;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    //代码省略</span><br><span class="line"></span><br><span class="line">    /** Override onCreateView to instantiate names that correspond to the</span><br><span class="line">        widgets known to the Widget factory. If we don&apos;t find a match,</span><br><span class="line">        call through to our super class.</span><br><span class="line">    */</span><br><span class="line">    @Override protected View onCreateView(String name, AttributeSet attrs) throws ClassNotFoundException &#123;</span><br><span class="line">        //在View名字的前面添加前缀来构造View的完整路径。</span><br><span class="line">        //例如类名为TextView,那么TextView的完整路径为android.widget.TextView</span><br><span class="line">        for (String prefix : sClassPrefixList) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                View view = createView(name, prefix, attrs);</span><br><span class="line">                if (view != null) &#123;</span><br><span class="line">                    return view;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                // In this case we want to let the base class take a crack</span><br><span class="line">                // at it.</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return super.onCreateView(name, attrs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PhoneLayoutInflater类的核心是覆写了LayoutInflater的onCreateView方法，该方法在传递进来的View名字前加上前缀以得到该内置View的完整路径。最后根据完整路径来构造对应的View对象。<br>    以Activity的setContentView为例，先来看看其实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"></span><br><span class="line">public class Activity extends ContextThemeWrapper</span><br><span class="line">        implements LayoutInflater.Factory2,</span><br><span class="line">        Window.Callback, KeyEvent.Callback,</span><br><span class="line">        OnCreateContextMenuListener, ComponentCallbacks2,</span><br><span class="line">        Window.OnWindowDismissedCallback &#123;</span><br><span class="line"> </span><br><span class="line">        </span><br><span class="line">    public void setContentView(View view) &#123;</span><br><span class="line">        getWindow().setContentView(view);</span><br><span class="line">        initWindowDecorActionBar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Activity的setContentView方法实际上调用的是Window的setContentView，而Window是一个抽象类，其具体实现类为PhoneWindow，PhoneWindow类中对应的方法如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">//路径：frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java</span><br><span class="line"></span><br><span class="line">public class PhoneWindow extends Window implements MenuBuilder.Callback &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void setContentView(int layoutResID) &#123;</span><br><span class="line">        // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span><br><span class="line">        // decor, when theme attributes and the like are crystalized. Do not check the feature</span><br><span class="line">        // before this happens.</span><br><span class="line">        //1、当mContentParent为空时先创建DecorView</span><br><span class="line">        if (mContentParent == null) &#123;</span><br><span class="line">            installDecor();</span><br><span class="line">        &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                    getContext());</span><br><span class="line">            transitionTo(newScene);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParent.requestApplyInsets();</span><br><span class="line">        final Callback cb = getCallback();</span><br><span class="line">        if (cb != null &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">            cb.onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yoursite.com/Android/2018/03/cjl6dv1m50002gcq6n1pisn8k.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liwenfeng">
      <meta itemprop="description" content="将来的你，一定会感谢此刻的自己……">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="愤怒的IT青年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Android/2018/03/cjl6dv1m50002gcq6n1pisn8k.html" itemprop="url">Android源码设计模式 学习笔记（一） 面向对象六大原则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-02T21:22:51+08:00">
                2018-03-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h2 id="面向对象六大原则"><a href="#面向对象六大原则" class="headerlink" title="面向对象六大原则"></a>面向对象六大原则</h2><h3 id="单一职责原则-SRP"><a href="#单一职责原则-SRP" class="headerlink" title="单一职责原则(SRP)"></a>单一职责原则(SRP)</h3><pre><code>单一职责原则(Single Responsibility Principle, SRP)：一个类只负责一个功能领域中的相应职责，或者可以定义为：就一个类而言，应该只有一个引起它变化的原因。
</code></pre><p>问题由来：类T负责两个不同的职责：职责P1，职责P2。当由于职责P1需求发生改变而需要修改类T时，有可能会导致原本运行正常的职责P2功能发生故障。</p>
<hr>
<h3 id="开闭原则-OCP"><a href="#开闭原则-OCP" class="headerlink" title="开闭原则(OCP)"></a>开闭原则(OCP)</h3><pre><code>开闭原则(Open-Closed Principle, OCP)：软件中的对象（类、模块、函数等）应该对于扩展是开放的，但是对于修改是封闭的。
</code></pre><p>当软件需要变化时，我们应该尽量通过扩展的方式实现变化，而不是通过修改原有的代码来实现。因为直接的修改，可能会影响已有的正常代码。不利于出现错误时排除问题。当然实际开发中，修改原有代码与扩展代码是同时存在的。但应尽量以扩展为主。</p>
<hr>
<h3 id="里氏替换原则（LSP）"><a href="#里氏替换原则（LSP）" class="headerlink" title="里氏替换原则（LSP）"></a>里氏替换原则（LSP）</h3><pre><code>里氏代换原则(Liskov Substitution Principle, LSP)：所有引用基类（父类）的地方必须能透明地使用其子类的对象。
</code></pre><p>​<br><strong>里氏代换原则是实现开闭原则的重要方式之一，由于使用基类对象的地方都可以使用子类对象，因此在程序中尽量使用基类类型来对对象进行定义，而在运行时再确定其子类类型，用子类对象来替换父类对象。</strong></p>
<p>里氏替换原则通俗的来讲就是：子类可以扩展父类的功能，但不能改变父类原有的功能。它包含以下4层含义：</p>
<ul>
<li>子类可以实现父类的抽象方法，但不能覆盖父类的非抽象方法。</li>
<li>子类中可以增加自己特有的方法。</li>
<li>当子类的方法重载父类的方法时，方法的前置条件（即方法的形参）要比父类方法的输入参数更宽松。</li>
<li>当子类的方法实现父类的抽象方法时，方法的后置条件（即方法的返回值）要比父类更严格。</li>
</ul>
<hr>
<p>在使用里氏代换原则时需要注意如下几个问题：</p>
<ul>
<li><p>(1)子类的所有方法必须在父类中声明，或子类必须实现父类中声明的所有方法。根据里氏代换原则，为了保证系统的扩展性，在程序中通常使用父类来进行定义，如果一个方法只存在子类中，在父类中不提供相应的声明，则无法在以父类定义的对象中使用该方法。</p>
</li>
<li><p>(2) 我们在运用里氏代换原则时，尽量把父类设计为抽象类或者接口，让子类继承父类或实现父接口，并实现在父类中声明的方法，运行时，子类实例替换父类实例，我们可以很方便地扩展系统的功能，同时无须修改原有子类的代码，增加新的功能可以通过增加一个新的子类来实现。里氏代换原则是开闭原则的具体实现手段之一。</p>
</li>
<li><p>(3) Java语言中，在编译阶段，Java编译器会检查一个程序是否符合里氏代换原则，这是一个与实现无关的、纯语法意义上的检查，但Java编译器的检查是有局限的。</p>
</li>
</ul>
<p>里氏替换原则就是依赖于面向对象语言的继承与多态。核心原理是抽象。<br>继承的优缺点： </p>
<ul>
<li>优点： <ul>
<li>（1）代码重用，减少创建类的成本，每个子类都拥有父类的方法与属性。 </li>
<li>（2）子类与父类基本相似，但与父类又有所区别。 </li>
<li>（3）提高代码的可扩展性。 </li>
</ul>
</li>
<li>缺点： <ul>
<li>（1）继承是侵入性的，只要继承就必须拥有父类所有的属性与方法。 </li>
<li>（2）可能造成子类代码冗余、灵活性降低。</li>
</ul>
</li>
</ul>
<p><a href="http://blog.csdn.net/zhengzhb/article/details/7281833" target="_blank" rel="noopener">链接：设计模式六大原则：里氏替换原则</a></p>
<hr>
<h3 id="依赖倒置原则（DIP）"><a href="#依赖倒置原则（DIP）" class="headerlink" title="依赖倒置原则（DIP）"></a>依赖倒置原则（DIP）</h3><pre><code>依赖倒转原则(Dependency Inversion  Principle, DIP)：抽象不应该依赖于细节，细节应当依赖于抽象。换言之，要针对接口编程，而不是针对实现编程。
</code></pre><p>如果说开闭原则是面向对象设计的目标的话，那么依赖倒转原则就是面向对象设计的主要实现机制之一，它是系统抽象化的具体实现。</p>
<p><strong>依赖倒转原则要求我们在程序代码中传递参数时或在关联关系中，尽量引用层次高的抽象层类，即使用接口和抽象类进行变量类型声明、参数类型声明、方法返回类型声明，以及数据类型的转换等，而不要用具体类来做这些事情。为了确保该原则的应用，一个具体类应当只实现接口或抽象类中声明过的方法，而不要给出多余的方法，否则将无法调用到在子类中增加的新方法。</strong></p>
<p>几个关键点：</p>
<ul>
<li>（1）高层模块不依赖于低层模块，应该都依赖其抽象。 </li>
<li>（2）抽象不依赖细节。 </li>
<li>（3）细节应依赖抽象。</li>
</ul>
<p><em>解释：在Java中，抽象就是指接口或者抽象类，两者都是不能直接被实例化的；细节就是实现类，实现接口或者继承抽象类而产生的就是细节，也就是可以加上一个关键字new产生的对象。高层模块就是调用端，底层模块就是具体实现类。</em></p>
<h3 id="接口隔离原则（ISP）"><a href="#接口隔离原则（ISP）" class="headerlink" title="接口隔离原则（ISP）"></a>接口隔离原则（ISP）</h3><pre><code>接口隔离原则(Interface  Segregation Principle, ISP)，类间的依赖关系应该建立在最小的接口上，将庞大、臃肿的接口拆分成更小的、更具体的接口。目的是系统的解耦，从而更容易重构、更改和重新部署。
</code></pre><h3 id="迪米特原则（LOD）"><a href="#迪米特原则（LOD）" class="headerlink" title="迪米特原则（LOD）"></a>迪米特原则（LOD）</h3><pre><code>(Law of  Demeter, LoD)一个类应该对自己需要耦合或者调用的类知道的最少，类的内部如何实现与调用者或者依赖者没有关系，调用者或依赖者只需知道他需要的方法，其他可以一概不管。这样使得系统具有更低的耦合与更好的可扩展性
</code></pre><hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yoursite.com/Hexo/2018/03/cjl6dv1mp0014gcq6heh8fldp.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liwenfeng">
      <meta itemprop="description" content="将来的你，一定会感谢此刻的自己……">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="愤怒的IT青年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Hexo/2018/03/cjl6dv1mp0014gcq6heh8fldp.html" itemprop="url">Hello Hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-01T21:22:51+08:00">
                2018-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前言：<br>这是我用Hexo发布的第一篇文章…………</p>
<p>之前一直用markdown在<a href="http://www.zybuluo.com" target="_blank" rel="noopener">zybuluo</a>上面写笔记<br>看到hexo效果那么高大上，而且能很好的管理markdown文章<br>于是……我用hexo搭建一个博客</p>
<p>hexo主要把markdown文章存放在<code>./hexo/source/_posts/</code>中进行管理</p>
<p>最后markdown编辑器可以用在线的<a href="http://www.zybuluo.com" target="_blank" rel="noopener">zybuluo</a>，本地我用的是Typora</p>
<h2 id="Hexo配置"><a href="#Hexo配置" class="headerlink" title="Hexo配置"></a>Hexo配置</h2><h3 id="生成文章插入图片"><a href="#生成文章插入图片" class="headerlink" title="生成文章插入图片"></a>生成文章插入图片</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>使用本地路径：在hexo/source目录下新建一个img文件夹，将图片放入该文件夹下，插入图片方法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![logo](img/logo.jpg)</span><br></pre></td></tr></table></figure></p>
<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>对于那些想要更有规律地提供图片和其他资源以及想要将他们的资源分布在各个文章上的人来说，Hexo也提供了更组织化的方式来管理资源，将站点配置文件中的 <code>post_asset_folder</code> 选项设为 <code>true</code> 来打开文章资源文件夹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: true</span><br></pre></td></tr></table></figure></p>
<p>博文中通过相对路径引用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% asset_img 图片文件名 %&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h4><ul>
<li>把主页配置文件<code>_config.yml</code>里的<code>post_asset_folder:</code>这个选项设置为<code>true</code></li>
<li>在<code>hexo</code>目录下执行<code>npm install hexo-asset-image --save</code>(需要等待一段时间)，下载安装一个可以上传本地图片的插件</li>
<li>运行<code>hexo new &quot;xxxx&quot;</code>来生成<code>md</code>博文时，<code>/source/_posts</code>文件夹内除了<code>xxxx.md</code>文件还有一个同名的文件夹</li>
<li>md中想引入图片时，先把图片放到xxxx这个文件夹中，在md中按照markdown的格式引入图片：</li>
<li><ul>
<li>例：:<code>![logo](xxxx/logo.jpg)</code></li>
</ul>
</li>
<li>检查：<code>hexo g</code>生成页面后，进入<code>public\2018\03\15\index.html</code>文件中查看相关字段，可以发现，<code>html</code>标签内的语句是<code>&lt;img src=&quot;2018/03/15/xxxx/图片名.jpg&quot;&gt;</code></li>
</ul>
<h4 id="方法四"><a href="#方法四" class="headerlink" title="方法四"></a>方法四</h4><p>使用<a href="https://www.qiniu.com" target="_blank" rel="noopener">七牛云储存</a> 或者其他图床，因为Github跟Coding项目容量有限，而且Github的主机在国外，访问速度较慢，把图片放在国内的图床上是个更好的选择~</p>
<h2 id="主要指令"><a href="#主要指令" class="headerlink" title="主要指令"></a>主要指令</h2><p>###创建一个新的Post</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>会在<code>./hexo/source/_posts/</code>目录生成对应md文件</p>
<h3 id="生成静态文件"><a href="#生成静态文件" class="headerlink" title="生成静态文件"></a>生成静态文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<h3 id="运行服务"><a href="#运行服务" class="headerlink" title="运行服务"></a>运行服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>成功提示<code>Hexo is running at http://localhost:4000/. Press Ctrl+C to stop</code><br>在本地<code>http://localhost:4000/</code>预览修改效果</p>
<h3 id="部署到远程站点"><a href="#部署到远程站点" class="headerlink" title="部署到远程站点"></a>部署到远程站点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="liwenfeng" />
            
              <p class="site-author-name" itemprop="name">liwenfeng</p>
			  <!--liwenfeng:change 2018.03.18 begin-->
              <p class="site-description motion-element" itemprop="description"></p>
			  <p class="site-description motion-element" itemprop="description">人若有才，清风自来</p>
			  <!--liwenfeng:change 2018.03.18 end-->
			  <p class="site-description motion-element" itemprop="description"></p>

          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" align="center">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liwenfeng</span>

  
</div>



<div align="center">
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
  本站访客数：<span id="busuanzi_value_site_pv"></span>
</span>
</div>


  <span class="post-meta-divider">|</span>


  <div class="powered-by">个人专属</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">博客 &mdash; <a class="theme-link" target="_blank" href="../">leewf</a></div>

</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
